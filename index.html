<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡πÄ‡∏Å‡∏°-‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå vocab happy land 2 ‡∏õ.4-6</title>
<style>

/* ===== ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤ ===== */
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNew.woff2') format('woff2'),
       url('image/THSarabunNew.woff') format('woff'),
       url('image/THSarabunNew.ttf') format('truetype');
  font-weight: 400; font-style: normal; font-display: swap;
}
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNewBold.woff2') format('woff2'),
       url('image/THSarabunNewBold.woff') format('woff'),
       url('image/THSarabunNewBold.ttf') format('truetype');
  font-weight: 700; font-style: normal; font-display: swap;
}
html, body, button, input, select, textarea, .pill, .btn, .btn-mini,
.levelBtn, #startTitle, #countdown, .label, #timer {
  font-family: 'MyGameFont', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
}

:root{
  --glass: rgba(0,0,0,.45);
  --ok: #10b981;
  --bad: #ef4444;
  --hud-top: 15px;                 
  --safe-top: env(safe-area-inset-top, 0px);

  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå fade ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */
  --fade-ms: 600ms;   /* ‡πÄ‡∏ä‡πà‡∏ô 400ms / 800ms */
}


*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{
  background: url("image/background2.png") center center / cover no-repeat fixed !important;
  overflow:hidden; color:#fff;
}
#game{ position:relative; width:100vw; height:100vh; overflow:hidden }

/* ===== HUD ===== */
.hud{
  position:fixed;
  inset: calc(var(--safe-top) + var(--hud-top)) 5px auto 38px !important;
  display:flex;
  align-items:center;
  gap:12px;
  justify-content:space-between;
  pointer-events:none;
  z-index:40000;
}

/* === ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á HUD ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ === */
/* ‡∏ã‡πà‡∏≠‡∏ô HUD ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏° ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ prestart */
body:not(.in-game):not(.prestart) .hud {
  display: none !important;
}
/* ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô in-game ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
body:not(.in-game) #clock {
  display: none !important;
}



/* ===== Game Clock (Top Center, uses existing timer) ===== */
#clock.clock-pill{
  position:fixed;
  top:14px;
  left:50%;
  transform:translateX(-50%);
  z-index:16000;
  pointer-events:none;

  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ */
  --clock-size: 40px;
  font-size: var(--clock-size);

  background: var(--glass);
  backdrop-filter: blur(6px);
  color:#fff;
  font-weight:1000;
  line-height:1;
  border-radius:999px;
  padding:8px 16px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  text-shadow:0 3px 10px rgba(0,0,0,.55);
}
@media (max-width:480px){
  #clock.clock-pill{ --clock-size: 28px; padding:6px 12px; }
}

.pill{ background:var(--glass); backdrop-filter:blur(6px); padding:8px 12px; border-radius:999px; box-shadow:0 4px 18px rgba(0,0,0,.25) }
#timer{ font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:.5px; font-size:20px }
.btn-mini{ pointer-events:auto; background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; box-shadow:0 4px 18px rgba(0,0,0,.25) }
.btn-mini:hover{ filter:brightness(1.1) }

.score-label{ font-size:20px; font-weight:900; color:#fff; margin-bottom:6px; text-align:center; width:100%; margin-top:-4px; }

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢ --score-size */
.pill.gold{
  --score-size: 42px;             /* << ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
  background: var(--glass);
  border-radius: 12px;
  padding: 6px 12px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: calc(var(--score-size) * 1.6);
  box-shadow: 0 4px 18px rgba(0,0,0,.25);
}
.pill.gold .num{
  font-size: var(--score-size);
  font-weight: 1000;
  font-variant-numeric: tabular-nums;
  letter-spacing: .5px;
}

@media (max-width:480px){ .pill.gold{ --gold-size:24px; --gold-cols:8; --gold-rows:2 } }

/* ===== Welcome / Landing ===== */
#landing{ position:fixed; inset:0; display:flex; flex-direction:column; gap:22px; align-items:center; justify-content:center; background:url("image/background2.png") center/cover no-repeat fixed !important; z-index:20000; transition:opacity .3s ease }
#landing.hide{ opacity:0; pointer-events:none; visibility:hidden }
#landing .brand{ width:min(92vw,1100px) }
#landing .brand img{ width:100%; height:auto; display:block; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)) }
#welcome{ position:fixed; inset:0; background:url("image/welcome.png") center/cover no-repeat fixed; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; z-index:25000; transition:opacity .3s ease; }
#welcome.hide{ opacity:0; pointer-events:none; visibility:hidden }
#welcome #enterBtn{ padding:12px 28px; font-size:clamp(22px,4vw,36px); font-weight:1000; letter-spacing:.2px; border:0; border-radius:16px; color:#fff; background:rgba(0,0,0,.55); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.18) }

#welcome .brand{ width:min(90vw,1000px); 
        margin-bottom:100px; 
        display:flex; 
        justify-content:center 
}

#welcome .brand 
        img{ width:130%; 
        height:auto; display:block; 
        animation:pulse 3s infinite ease-in-out; 
        filter:drop-shadow(0 6px 18px rgba(0,0,0,.45)) 
}

#welcome .welcome-content{ 
       display:flex; 
       flex-direction:column; 
       align-items:center; gap:0; 
       margin-top:100px 
}
@keyframes pulse{ 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.04);opacity:.9} }
.level-menu{ display:flex; flex-direction:column; gap:14px; width:min(92vw,640px) }
.levelBtn{ width:100%; padding:10px 16px; font-size:clamp(20px,4vw,34px); font-weight:1000; letter-spacing:.2px; border:0; border-radius:14px; color:#fff; background:rgba(0,0,0,.55); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; text-align:center; border:1px solid rgba(255,255,255,.18); backdrop-filter:blur(6px) }

#startScreen{
  position:fixed;
  inset:0;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.9);
  z-index:30000;       
  text-align:center;
  padding:24px;
}

#startTitle{ font-size:clamp(26px,5vw,48px); font-weight:900; margin-bottom:10px }
#startBtn{ margin-top:12px; padding:10px 18px; border:0; border-radius:12px; font-weight:800; cursor:pointer; background:#1f2937; color:#fff }
#countdown{ display:none; font-size:clamp(56px,12vw,120px); font-weight:1000; line-height:1; margin-top:8px }

/* ===== ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á-‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) ===== */
#qImg{
  position:absolute;
  top: 50%;
  left: 50%;
  max-width: min(60vw, 720px);
  max-height: min(48vh, 480px);
  width:auto; height:auto;
  display:none;
  z-index:9;
  filter: drop-shadow(0 10px 30px rgba(0,0,0,.45));
  border-radius: 12px;

  /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ó‡πâ ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏° FX */
  transform: translate(-50%, -50%)
             translate(var(--fxX, 0), var(--fxY, 0))
             scale(var(--fxS, 1));

  transition:
    transform 520ms cubic-bezier(.2,.9,.2,1),
    opacity 520ms;
}


/* ===== ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ FX) ===== */
#questionBox{
  position: fixed;             /* ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô absolute ‚Üí fixed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏¥‡∏á viewport ‡∏ï‡∏•‡∏≠‡∏î */
  top: var(--qTop);            /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô */
  left: 50%;
  transform: translate(-50%, 0)
             translate(var(--fxX, 0), var(--fxY, 0))
             scale(var(--fxS, 1));
  background:none; border:none; padding:0;
  font-size: clamp(var(--qFontMin), var(--qFontVW), var(--qFontMax)); 
  font-weight:1000; color:#fff;
  text-shadow:0 4px 12px rgba(0,0,0,.8);
  z-index: 10;
  white-space:pre; overflow:visible; text-align:center;
  transition: transform 520ms cubic-bezier(.2,.9,.2,1), opacity 520ms;
}

#questionBox.pre-drop{
  top: calc(var(--qTop) - 40px);
  opacity: 0;
}

/* ===== ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏° 2 ‡∏õ‡∏∏‡πà‡∏° ===== */
.option.circle{
  position:absolute;
  width: var(--c-sz, clamp(120px, 18vw, 220px));
  height: var(--c-sz, clamp(120px, 18vw, 220px));
  border-radius:50%;
  border:10px solid transparent;
  background:
    radial-gradient(35% 35% at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%) padding-box,
    var(--ring, linear-gradient(130deg,#999,#666)) border-box;
  box-shadow:0 8px 28px rgba(0,0,0,.35);
  display:grid; place-items:center;
  cursor:pointer; user-select:none; z-index:12;
  transition: top 800ms cubic-bezier(.2,.9,.2,1),
             left 800ms cubic-bezier(.2,.9,.2,1);
}

.option.circle .label{ 
       font-weight:1000; 
       font-size:clamp(18px,2.2vw,32px); 
       color:#fff; 
       text-align:center; 
       text-shadow:0 3px 10px rgba(0,0,0,.6); 
       padding:0 10px; line-height:1.15 }

/* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà ===== */
.option.circle.live {
  background: rgba(0,0,0,.55);                  
  border: 10px solid #d97706;                    
  box-shadow: 0 6px 18px rgba(0,0,0,.35);       
}

.option.circle.non {
  background: rgba(0,0,0,.55);                  
  border: 10px solid #a855f7;                  
  box-shadow: 0 6px 18px rgba(0,0,0,.35);      
}

/* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) */
.option.circle {
  --c-sz: clamp(140px, 20vw, 240px);        
}

/* ===== ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö zoom-in-bounce ===== */
.option.circle.in-anim {
  animation: zoomInBounce 650ms cubic-bezier(.25,.8,.25,1) forwards;
  transform: scale(0.3);      /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏≤‡∏á */
  opacity: 0;
}

@keyframes zoomInBounce {
  0%   { transform: scale(0.3); opacity: 0; }
  60%  { transform: scale(1.1); opacity: 1; }  
  100% { transform: scale(1);   opacity: 1; }
}

/* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) */
.option.circle .label {
  font-size: clamp(22px, 3vw, 40px);          /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
  font-weight: 900;                             /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ */
  letter-spacing: .5px;                         /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
  color: #fff;                                  /* ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
}

.option.circle.glow{
  filter: drop-shadow(0 0 10px rgba(250,204,21,.70)) drop-shadow(0 0 18px rgba(250,204,21,.55));
}

/* ===== ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ===== */
#timebarWrap{ position:fixed; left:0; right:0; bottom:0; height:12px; background:rgba(255,255,255,.12); z-index:16000; border-top:1px solid rgba(255,255,255,.2) }
#timebar{ height:100%; width:0%; background:#10b981; transition:width .1s linear }

/* ===== ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå/Toast/‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ===== */
#flash{ position:fixed; inset:0; background:transparent; pointer-events:none; z-index:17000 }
.flash-clear{ animation: flashC 2000ms ease-out }
@keyframes flashC{ 0%{background:rgba(255,255,255,.55)} 100%{background:transparent} }

.flash-in{ animation: flashIn .35s ease-out }
@keyframes flashIn{
  0%{ opacity:0; transform:translate(-50%,-50%) scale(1.04); box-shadow:0 0 0 0 rgba(255,255,255,0), 0 0 0 0 rgba(255,255,255,0) }
  30%{ opacity:1; box-shadow:0 0 24px 6px rgba(255,255,255,.75), 0 0 64px 12px rgba(255,255,255,.55) }
  100%{ opacity:1; transform:translate(-50%,-50%) scale(1); box-shadow:none }
}
.flash-in-cover{ animation: flashInCover .35s ease-out }
@keyframes flashInCover{
  0%{ opacity:0; box-shadow:0 0 0 0 rgba(255,255,255,0), 0 0 0 0 rgba(255,255,255,0) }
  30%{ opacity:1; box-shadow:0 0 24px 6px rgba(255,255,255,.75), 0 0 64px 12px rgba(255,255,255,.55) }
  100%{ opacity:1; box-shadow:none }
}

#roundToast{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,.78); border:1px solid rgba(255,255,255,.22);
  padding:18px 26px; border-radius:16px; font-size:clamp(22px,3vw,34px); font-weight:900;
  z-index:17500; display:none; text-align:center; white-space:nowrap; line-height:1.25;
}
#roundToast .q{ display:block }
#roundToast .a{ display:block; margin-top:.15em; opacity:.95 }
#roundToast .r{ display:block; margin-top:.35em; font-weight:1000 }
#roundToast .r.ok{ color:var(--ok) }
#roundToast .r.bad{ color:var(--bad) }

#ansImg{
  position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; object-position:center;
  opacity:.95; filter: drop-shadow(0 20px 60px rgba(0,0,0,.50));
  z-index:17499; display:none; pointer-events:none;
}

/* ===== ‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™ AR ===== */
#cameraMirror{ position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; transform: scaleX(-1); z-index:1; display:none; background:#000 }
#camCanvas{ position:fixed; inset:0; width:100vw; height:100vh; z-index:2; pointer-events:none; display:none }
#game{ z-index:3; position:relative }

/* ‡∏õ‡∏∏‡πà‡∏° Mute / Fullscreen (‡∏î‡∏±‡∏ô‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î) */
#muteBtn, #fsBtn{
  position: fixed;
  right: 12px;
  width: 44px;
  height: 44px;
  border-radius: 999px;
  background: rgba(0,0,0,.45);
  border: 1px solid rgba(255,255,255,.3);
  color: #fff;
  font-size: 18px;
  line-height: 1;
  display: grid;
  place-items: center;
  cursor: pointer;
  z-index: 50000; /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ HUD ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å overlay ‡πÉ‡∏ô‡πÄ‡∏Å‡∏° */
}
#muteBtn{ bottom:12px }
#fsBtn{ bottom:62px }


/* ‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡∏ö‡∏±‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ) */
body::after{ content:""; position:fixed; top:0; left:0; width:var(--corner-img-w, 220px); height:var(--corner-img-h, 220px); background:url("image/button1.png") no-repeat left top / contain; pointer-events:none; z-index:10000 }
body::before{ content:""; position:fixed; top:0; right:0; width:var(--corner2-img-w, 200px); height:var(--corner2-img-h, 200px); background:url("image/button2.png") no-repeat right top / contain; pointer-events:none; z-index:10000 }

/* ===== ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏Ç‡∏ô‡∏°‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏∏‡∏° ===== */
.fly-emoji{
  position:fixed;
  left:50vw;             /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ */
  top:50vh;
  font-size:clamp(48px, 8vw, 96px); /* üëà ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  line-height:1;
  pointer-events:none;
  z-index:20000;
  opacity:0;
  transform:translate(0,0) scale(.9);
  filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
}

/* ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤/‡∏ó‡∏¥‡∏®‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ --emoji-ms, --dx, --dy */
.fly-emoji.go{
  animation: emojiFly var(--emoji-ms, 1200ms) cubic-bezier(.2,.8,.2,1) forwards;
}

@keyframes emojiFly{
  0%   { opacity:0; transform:translate(0,0) scale(.9); }
  10%  { opacity:1; }
  100% { opacity:0; transform:translate(var(--dx, 0), var(--dy, -300px)) scale(1.1); }
}
/* ===== ‡∏à‡∏ö‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏Ç‡∏ô‡∏° ===== */


/* ===== ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏´‡∏°‡∏∏‡∏ô + ‡∏à‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏° ===== */
.option.circle.flip-out {
  animation: flipOut 600ms ease forwards;
}

@keyframes flipOut {
  0%   { transform: rotateY(0deg) scale(1); opacity:1; }
  50%  { transform: rotateY(180deg) scale(1.1); opacity:0.9; }
  100% { transform: rotateY(360deg) scale(0.8); opacity:0; }
}


#timebarWrap{ display:none !important }

/* ‡∏à‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÜ (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ --fade-ms) */
.option.circle.fade-out {
  animation: fadeOut var(--fade-ms, 600ms) ease forwards;
}

@keyframes fadeOut {
  0%   { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(0.9); }
}

/* ===== ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ (Vocab Happy Land) ===== */
.option.img{
  position:absolute;
  display:grid; place-items:center;
/* ‚ñº‚ñº‚ñº ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Å‡∏£‡∏≠‡∏ö/‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á/‡∏Ç‡∏≠‡∏ö/‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á transition left/top */
  padding:0;
  border-radius:0;
  background: transparent;
  border: 0;
  box-shadow: none;
  width:  var(--imgW, clamp(240px, 30vw, 420px));
  height: var(--imgH, clamp(240px, 30vw, 420px));
  cursor:pointer; user-select:none; z-index:12;
/* ‡πÄ‡∏î‡∏¥‡∏°:
  transition: top 800ms cubic-bezier(.2,.9,.2,1),
             left 800ms cubic-bezier(.2,.9,.2,1);
*/
  transition: none;
}
.option.img.in-anim{
  animation: zoomInBounce 650ms cubic-bezier(.25,.8,.25,1) forwards;
  transform: scale(0.3);
  opacity: 0;
}
/* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ --fade-ms ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô */
.option.img.fade-out { animation: fadeOut var(--fade-ms, 600ms) ease forwards; }

.option.img.flip-out { animation: flipOut 600ms ease forwards; }

/* ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ */
.option.img > img{
  max-width:100%;
  max-height:100%;
  width:auto; height:auto;
  object-fit:contain;
  display:block;
/* ‚ñº‚ñº‚ñº ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏á‡∏≠‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≤‡∏•‡∏á */
  filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
  border-radius:0;
}
/* ‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠: ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ JS ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å x ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏á */

/* === Tap target ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≠‡∏ö (emoji ‡∏Ç‡∏ô‡∏°) === */
.tap-target{
  position:absolute;
  font-size: var(--bonus-size, 162px);   /* ‚Üê ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ */
  line-height: 1;
  user-select:none;
  cursor:pointer;
  z-index: 20050;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
  transition: transform 120ms ease;
}
.tap-target:active{ transform: scale(.92); }

/* ===== ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏ü‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô) ===== */
.tap-target {
  position:absolute;
  font-size: var(--bonus-size, 162px);   /* ‚Üê ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ */
  line-height: 1;
  user-select:none;
  cursor:pointer;
  z-index: 20050;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
  transition: transform 120ms ease;

  /* ‡∏ü‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ 520ms + ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏≠‡∏∑‡πà‡∏ô 120ms */
  animation:
    emojiFadeIn 520ms ease-out both,
    glowPulse 1.8s ease-in-out infinite 120ms,
    wiggle 1.4s ease-in-out infinite 120ms;
  will-change: opacity;
}

.tap-target:active {
  transform: scale(.92);
}

.tap-target.disappear {
  animation: emojiFadeOut 400ms ease-in-out forwards !important;
}

/* ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö fade-in (‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà 0) */
@keyframes emojiFadeIn {
  0%   { opacity: 0; }
  45%  { opacity: 0; }
  100% { opacity: 1; }
}

/* ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö fade-out */
@keyframes emojiFadeOut {
  0%   { opacity: 1; }
  100% { opacity: 0; }
}

/* --- Glow for emoji (style only; ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á animation ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö fade) --- */
.tap-target{
  text-shadow:
    0 0 10px rgba(255,255,255,.70),
    0 0 22px rgba(255,210,120,.55),
    0 0 36px rgba(255,140,0,.40);
}


/* ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà animation ‡∏ó‡∏µ‡πà .glow ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å */
.tap-target.glow{ /* optional: ‡∏à‡∏∞‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ */
  /* no animation here */
}


@keyframes wiggle {
  0%, 100% {
    transform: rotate(0deg);
  }
  15% {
    transform: rotate(-6deg);
  }
  30% {
    transform: rotate(6deg);
  }
  45% {
    transform: rotate(-4deg);
  }
  60% {
    transform: rotate(4deg);
  }
  75% {
    transform: rotate(-2deg);
  }
  90% {
    transform: rotate(2deg);
  }
}


/* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏£‡∏π‡∏õ (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à) */
:root{
  --qTop: 8vh;    /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ ~8% ‡∏™‡∏π‡∏á‡∏à‡∏≠ */
  --qLeft: 50%;
  --qFontMin: 24px;
  --qFontVW:  25vw;
  --qFontMax: 100px;
}

@media (max-width:420px){
  .option.circle { --c-sz: clamp(110px, 28vw, 180px); }
}

.option.circle {
  overflow: visible;
  contain: layout paint;
}

.fx{
  --fxX: 0;
  --fxY: 0;
  --fxS: 1;
  will-change: transform, opacity;
  transition: transform 520ms cubic-bezier(.2,.9,.2,1), opacity 520ms;
}
/* ‡πÄ‡∏Ç‡πâ‡∏≤: slide-in ‡∏à‡∏≤‡∏Å‡∏ö‡∏ô */
.in-pre { opacity:0; --fxY: -40px; }
.in-go  { opacity:1; --fxY: 0;     }
/* ‡∏≠‡∏≠‡∏Å: ‡∏ï‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
.out-left  { opacity:0; --fxX: -90px; }
.out-right { opacity:0; --fxX:  90px; }

/* === ‡∏™‡∏µ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πà‡∏≤‡∏ô 2 ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏£‡∏Å === */
.option.circle.choiceA {
  background: rgba(0,0,0,.55);
  border: 10px solid #a855f7;   /* ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô .non */
  box-shadow: 0 6px 18px rgba(0,0,0,.35);
}
.option.circle.choiceB {
  background: rgba(0,0,0,.55);
  border: 10px solid #d97706;   /* ‡∏™‡πâ‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô .live */
  box-shadow: 0 6px 18px rgba(0,0,0,.35);
}

.hud {
  position: initial !important;   /* ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å fixed ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏° */
  inset: auto !important;         /* ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ inset ‡πÄ‡∏î‡∏¥‡∏° */
}

.hud .left,
.hud .right {
  position: fixed !important;
  top: var(--hud-top) !important;   /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á‡πÑ‡∏î‡πâ */
  z-index: 40000 !important;  /* ‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡∏ô‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô */
  pointer-events: none;
}

.hud .left { left: 20px !important; }
.hud .right { right: 20px !important; }

.hud .btn-mini {
  pointer-events: auto;   /* ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ */
}

/* ===== Result Panel (‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏ß‡∏¢ ‡πÜ) ===== */
.result-panel{
  --panel-bg: rgba(20,20,20,.92);
  --panel-br: 20px;
  --panel-bd: 1px solid rgba(255,255,255,.12);
  --shadow: 0 20px 60px rgba(0,0,0,.55);
  background: var(--panel-bg);
  border: var(--panel-bd);
  padding: clamp(20px, 4vw, 32px);
  border-radius: var(--panel-br);
  width: min(92vw, 640px);
  display: grid;
  grid-template-rows: auto auto auto auto;
  gap: clamp(12px, 2vw, 18px);
  text-align: center;
  box-shadow: var(--shadow);
  backdrop-filter: blur(6px);
}

.result-title{
  margin: 0;
  font-weight: 1000;
  font-size: clamp(28px, 4.5vw, 44px);
  letter-spacing: .2px;
  text-shadow: 0 4px 14px rgba(0,0,0,.35);
}

.badge{
  font-size: clamp(56px, 10vw, 120px);
  line-height: 1;
  filter: drop-shadow(0 8px 24px rgba(0,0,0,.45));
  margin-top: 6px;
  margin-bottom: 4px;
}

.result-metrics{
  display: grid;
  grid-template-columns: 1fr;
  gap: clamp(10px, 2vw, 16px);
  margin-top: 4px;
}

.metric{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 16px;
  padding: clamp(10px, 2vw, 16px);
  box-shadow: 0 8px 26px rgba(0,0,0,.25) inset, 0 8px 24px rgba(0,0,0,.25);
}

.metric .label{
  font-size: clamp(14px, 2.2vw, 18px);
  opacity: .9;
  margin-bottom: 4px;
}

.metric .value{
  font-size: clamp(28px, 5.5vw, 52px);
  font-weight: 1000;
  line-height: 1;
  letter-spacing: .3px;
}

/* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏™‡∏µ‡∏ä‡∏±‡∏î */
.result-actions{
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 6px;
}

.btn{
  appearance: none;
  border: none;
  border-radius: 14px;
  padding: clamp(10px, 2.2vw, 14px) clamp(16px, 3.5vw, 24px);
  font-weight: 900;
  font-size: clamp(16px, 2.8vw, 20px);
  cursor: pointer;
  box-shadow: 0 10px 28px rgba(0,0,0,.35);
  transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
}

.btn:active{ transform: translateY(1px) scale(.99); }

/* ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å: ‡πÄ‡∏Ç‡πâ‡∏° + ‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
.btn.strong{
  color: #fff;
  background: linear-gradient(180deg, #3b82f6, #1d4ed8);
  border: 1px solid rgba(255,255,255,.15);
}
.btn.strong:hover{ filter: brightness(1.08); }

/* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≠‡∏á: ‡πÇ‡∏õ‡∏£‡πà‡∏á */
.btn.ghost{
  color: #fff;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.18);
}
.btn.ghost:hover{ filter: brightness(1.1); }


</style>
</head>
<body>

<!-- ==== AR Mirror ==== -->
<video id="cameraMirror" playsinline muted></video>
<canvas id="camCanvas"></canvas>

<div id="game" aria-label="‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°">
  <div id="questionBox" aria-live="polite"></div>
  <img id="qImg" alt="‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°" />
</div>

<!-- ===== Welcome (‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î) ===== -->
<div id="welcome" role="dialog" aria-modal="true">
  <div class="welcome-content">
    <div class="brand"><img src="image/banner2.png" alt="Banner"></div>
    <button id="enterBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°</button>
  </div>
</div>

<!-- ===== Landing ===== -->
<div id="landing" role="dialog" aria-modal="true" class="hide">
  <div class="brand"><img src="image/banner2.png" alt="Banner"></div>
<div class="level-menu">
  <button class="levelBtn" data-level="2">Food</button>
  <button class="levelBtn" data-level="1">Disease</button>
  <button class="levelBtn" data-level="3">Place</button>
  <button class="levelBtn" id="guideBtn">How to play üìñ</button>
   </div>
</div>

<!-- ===== ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ===== -->
<div id="startScreen">
  <div id="startTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
  <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
  <div id="countdown">3</div>
</div>

<!-- ===== ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ===== -->
<div id="guideScreen" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:url('image/background2.png') center/cover no-repeat; z-index:20001">
  <div class="guide-wrap" style="width:min(95vw, 1200px); max-height:92vh; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center">
    <img src="image/guide.png" alt="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡∏°" style="width:100%; height:auto; max-height:92vh; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.55); display:block">
    <button id="guideBack" class="btn-mini">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>
</div>

<!-- ===== HUD ===== -->
<div class="hud">
  <div class="left">
    <div class="stack">
      <div style="display:flex; gap:8px;">
        <button id="quickRestart" class="btn-mini">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button id="pauseBtn" class="btn-mini">‚è∏ ‡∏´‡∏¢‡∏∏‡∏î</button>
        <button id="camBtn" class="btn-mini">üì∑: ‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="stack" style="align-items:flex-end">
      <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      <div id="goldWrap" class="pill gold" aria-live="polite" title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"></div>
    </div>
  </div>
</div>

<!-- ===== ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ===== -->
<div id="timebarWrap"><div id="timebar"></div></div>
<div id="flash"></div>
<div id="roundToast"></div>
<img id="ansImg" src="" alt="answer background">

<!-- ===== ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô ===== -->
<div id="overlay" style="visibility:hidden; opacity:0; transition:.25s; position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); z-index:9999">
  <div class="result-panel">
    <div class="badge" id="scoreBadge" aria-hidden="true">üèÜ</div>
    <h1 class="result-title" id="endTitle">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</h1>

<div class="result-metrics">
  <div class="metric">
    <div class="label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="value"><b id="finalScore">0</b></div>
  </div>
</div>

    <div class="result-actions">
      <button class="btn strong" id="restartBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      <button class="btn ghost" id="selectLevelBtn">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ===== -->
<audio id="hitSound" preload="auto" src="image/audio1.mp3"></audio>
<audio id="winSound" preload="auto" src="image/win2.mp3"></audio>
<audio id="bgm" preload="auto" loop src="image/bgm3.mp3"></audio>
<audio id="selectSound" preload="auto" src="image/select.mp3"></audio>
<audio id="eatSound" preload="auto" src="image/eat.mp3"></audio>
<audio id="voiceAudio" preload="auto"></audio>
<audio id="wrongSound" preload="auto" src="image/wrong.mp3"></audio>

<!-- ===== ‡∏õ‡∏∏‡πà‡∏° Mute / Fullscreen ===== -->
<button id="muteBtn" aria-pressed="false" title="Mute / Unmute">üîä</button>
<button id="fsBtn" aria-pressed="false" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">‚õ∂</button>

<!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Mute (BGM ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ===== -->
<script>
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const bgm     = document.getElementById('bgm');   // üéµ ‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  if(!muteBtn || !bgm) return;

  let bgmMuted = false;      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ mute ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ BGM

  function applyBgmMute(m){
    bgmMuted = !!m;
    bgm.muted = bgmMuted;    // ‚úÖ ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏Ñ‡πà bgm
    muteBtn.setAttribute('aria-pressed', String(bgmMuted));
    muteBtn.textContent = bgmMuted ? 'üîá' : 'üîä';
  }

  muteBtn.addEventListener('click', () => applyBgmMute(!bgmMuted));
})();
</script>


<!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Fullscreen ===== -->
<script>
(function(){
  const fsBtn = document.getElementById('fsBtn');
  if (!fsBtn) return;
  function fsEnabled(){ return document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled }
  function isFull(){ return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement }
  function requestFS(){ const el=document.documentElement; (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen)?.call(el) }
  function exitFS(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen)?.call(document) }
  function render(){ const on=!!isFull(); fsBtn.setAttribute('aria-pressed', String(on)); fsBtn.title = on ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠'; fsBtn.textContent = on ? 'üóó' : '‚õ∂' }
  if (!fsEnabled()){ fsBtn.style.display='none'; return }
  fsBtn.addEventListener('click', () => { if(isFull()) exitFS(); else requestFS() });
  document.addEventListener('fullscreenchange', render);
  document.addEventListener('webkitfullscreenchange', render);
  document.addEventListener('msfullscreenchange', render);
  render();
})();
</script>

<!-- ===== ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏° (2 ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ===== -->
<script>
(()=>{

  /* ---------- DOM ---------- */
  const game = document.getElementById('game');
  const qBox = document.getElementById('questionBox');
  const qImg = document.getElementById('qImg');
  const timebar = document.getElementById('timebar');
  const timebarWrap = document.getElementById('timebarWrap');
  const flash = document.getElementById('flash');
  const toast = document.getElementById('roundToast');
  const goldWrap = document.getElementById('goldWrap');  // << ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ


/* ===== Clock UI for existing game timer ===== */
const clockEl = document.createElement('div');
clockEl.id = 'clock';
clockEl.className = 'clock-pill';
clockEl.textContent = '02:00';               // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏° GAME_DURATION_MS
document.body.appendChild(clockEl);

let clockUIItv = null;        // interval ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
let clockState = 'idle';       // 'idle' | 'run' | 'pause' | 'end'

function fmtClock(ms){
  const total = Math.max(0, Math.ceil(ms/1000));
  const m = String(Math.floor(total/60)).padStart(2,'0');
  const s = String(total % 60).padStart(2,'0');
  return m + ':' + s;
}
function renderClockFromGame(){
  // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ç‡∏≠‡∏á "‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°": remainingMs, gameEndAt, ended
  const ms = (clockState === 'run')
    ? Math.max(0, (gameEndAt - performance.now()))
    : remainingMs; // pause/idle ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ
  clockEl.textContent = fmtClock(ms);
}
function startClockUI(){
  clockState = 'run';
  if (!clockUIItv) clockUIItv = setInterval(renderClockFromGame, 250);
  renderClockFromGame();
}
function pauseClockUI(){
  clockState = 'pause';
  if (clockUIItv){ clearInterval(clockUIItv); clockUIItv = null; }
  renderClockFromGame();
}
function resumeClockUI(){
  clockState = 'run';
  if (!clockUIItv) clockUIItv = setInterval(renderClockFromGame, 250);
  renderClockFromGame();
}
function stopClockUI(){
  clockState = 'end';
  if (clockUIItv){ clearInterval(clockUIItv); clockUIItv = null; }
  renderClockFromGame();
}
function resetClockUI(){
  clockState = 'idle';
  if (clockUIItv){ clearInterval(clockUIItv); clockUIItv = null; }
  // ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á GAME_DURATION_MS
  clockEl.textContent = fmtClock(GAME_DURATION_MS);
}


  const overlay = document.getElementById('overlay');
  const finalScoreEl = document.getElementById('finalScore');
  const finalRoundsEl = document.getElementById('finalRounds');
  const restartBtn = document.getElementById('restartBtn');
  const selectLevelBtn = document.getElementById('selectLevelBtn');

    window.currentLevel = 1; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏î‡πà‡∏≤‡∏ô 1


  // Welcome -> Landing
  (function(){
    const welcome = document.getElementById('welcome');
    const enterBtn = document.getElementById('enterBtn');
    const landing = document.getElementById('landing');

 enterBtn.addEventListener('click', ()=>{ 
    welcome.classList.add('hide'); 
    landing.classList.remove('hide');
    bgm?.play?.().catch(()=>{}); 
 });
  })();

function renderGold(score){
  const n = Number(score) || 0;
  goldWrap.innerHTML = `<span class="num">${n}</span>`;
  goldWrap.setAttribute('aria-label', `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${n}`);
}

// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î
if (window.innerWidth < 480 && goldWrap) {
  goldWrap.style.setProperty('--score-size', '28px');
}

  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  const hitSound = document.getElementById('hitSound');
  const winSound = document.getElementById('winSound');
  const bgm = document.getElementById('bgm');
  const selectSound = document.getElementById('selectSound');
  const eatSound = document.getElementById('eatSound');
  const voiceAudio = document.getElementById('voiceAudio'); // üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô
const wrongSound = document.getElementById('wrongSound'); // üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î


  if (bgm) {
    bgm.loop = true;
    bgm.addEventListener('ended', () => {
      try {
        bgm.currentTime = 0;
        bgm.play()?.catch(()=>{});
      } catch (_) {}
    });
  }

const VOL_BGM=0.15, VOL_SELECT=0.45, VOL_HIT=0.65, VOL_WIN=0.75, VOL_EAT=0.25, VOL_VOICE=1;
const VOL_WRONG=0.70;  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î


function applyBackendVolume(){
  if (bgm) bgm.volume = VOL_BGM;
  if (selectSound) selectSound.volume = VOL_SELECT;
  if (hitSound) hitSound.volume = VOL_HIT;
  if (winSound) winSound.volume = VOL_WIN;
  if (eatSound) eatSound.volume = VOL_EAT;
  if (voiceAudio) voiceAudio.volume = VOL_VOICE;
    if (wrongSound) wrongSound.volume = VOL_WRONG;


}
applyBackendVolume();

// ‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å mute ‡∏Ç‡∏≠‡∏á SFX ‡∏Å‡∏±‡∏ö BGM ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
function playSfx(el, vol){
  try{
    const n = el?.cloneNode(true);
    if(!n) return;
    n.volume = (typeof vol === 'number')
      ? Math.max(0, Math.min(1, vol))
      : (el.volume ?? 1);
    n.muted = false;           // ‚úÖ SFX ‡πÑ‡∏°‡πà mute ‡∏ï‡∏≤‡∏° bgm
    n.play?.();
  }catch(_){}
}


  // util
  const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const pick=(arr)=>arr[rand(0,arr.length-1)];
  const shuffle=(arr)=>{ const A=arr.slice(); for(let i=A.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [A[i],A[j]]=[A[j],A[i]] } return A };

/* ===== ‡∏û‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô: data1, data2, data3 (word1..word50) ===== */
const IMG_EXT = '.png';                           // ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô .webp ‡∏´‡∏£‡∏∑‡∏≠ .jpg ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
function buildPool(dir, count=50, ext=IMG_EXT){
  const m = new Map();                            // key: 'word1' ‚Üí path 'data1/word1.png'
  for(let i=1;i<=count;i++){
    const key = 'word'+i;
    m.set(key, `${dir}/${key}${ext}`);
  }
  return m;
}

function buildPoolSplit({
  dirA, fromA, toA,
  dirB, fromB, toB,
  ext = IMG_EXT
}){
  const m = new Map();
  for(let i=fromA;i<=toA;i++){
    const key = 'word'+i;
    m.set(key, `${dirA}/${key}${ext}`);
  }
  for(let i=fromB;i<=toB;i++){
    const key = 'word'+i;
    m.set(key, `${dirB}/${key}${ext}`);
  }
  return m;
}

const LEVEL_POOLS = {
  1: buildPool('data1', 15),
  2: buildPool('data2', 37),
  3: buildPoolSplit({
    dirA:'data3', fromA:1,  toA:17,
    dirB:'data4', fromB:18, toB:36
  })
};


// === Image preloader (‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡∏ä ‡∏Å‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥) ===
const __imgUrlCache  = new Set();          // ‡∏à‡∏≥‡∏ß‡πà‡∏≤ URL ‡πÑ‡∏´‡∏ô ‚Äú‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏´‡∏•‡∏î‚Äù ‡πÅ‡∏•‡πâ‡∏ß
const __imgElemCache = new Map();          // url -> HTMLImageElement ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥
// === Audio preloader (voice) ===
const __audioUrlCache  = new Set();          // ‡∏à‡∏≥‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
const __audioElemCache = new Map();          // url -> HTMLAudioElement

function warmAudio(url){
  if (__audioElemCache.has(url)) return __audioElemCache.get(url);

  const a = new Audio();
  a.preload = 'auto';
  a.src = url;
  a.load();                // ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
  __audioUrlCache.add(url);
  __audioElemCache.set(url, a);
  return a;
}


async function warmDecode(url){
  if (__imgElemCache.has(url)) {
    const im = __imgElemCache.get(url);
    if (im && im.complete && im.naturalWidth > 0) return im;
  }
  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß decode
  const im = new Image();
  im.decoding = 'async';
  im.loading  = 'eager';
  im.src = url;
  try { await im.decode(); } catch(_) {}
  __imgUrlCache.add(url);
  __imgElemCache.set(url, im);
  return im;
}

/**
 * ‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI + decode ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
 */
function preloadImages(urls = [], onProgress = ()=>{}, onDone = ()=>{}) {
  let done = 0;
  const total = urls.length;
  if (!total) { onDone(); return; }

  Promise.all(urls.map(async (u)=>{
    if (!u) { done++; onProgress(done,total); return; }
    if (__imgUrlCache.has(u)) { done++; onProgress(done,total); return; }
    await warmDecode(u);       // ‡πÇ‡∏´‡∏•‡∏î + decode + ‡πÄ‡∏Å‡πá‡∏ö __imgElemCache
    done++; onProgress(done,total);
  })).then(onDone);
}


/** ‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å LEVEL_POOLS (data1/2/3) */
function collectLevelImageUrls(level) {
  const pool = LEVEL_POOLS[level] || new Map();
  return [...pool.values()].filter(Boolean);
}

function collectLevelVoiceUrls(level){
  let max = 50;
  let base = 1;
  let folder = 'sound1';

  if (level === 2){ base = 51; folder = 'sound2'; }
  else if (level === 3){ base = 101; folder = 'sound3'; }

  const urls = [];
  for (let i=0; i<max; i++){
    urls.push(`${folder}/voice${base + i}.mp3`);
  }
  return urls;
}

// === ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏î‡πà‡∏≤‡∏ô + ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ UI ‡πÉ‡∏ä‡πâ ===
let __preloadDone = 0;
let __preloadTotal = 0;
let IMAGES_READY = false;

function __collectAllUrls(){
  return [
    ...collectLevelImageUrls(1),
    ...collectLevelImageUrls(2),
    ...collectLevelImageUrls(3),
  ].filter(Boolean);
}



function __renderPreloadProgress(){
  const el = document.getElementById('startTitle');
  if (!el) return;
  el.textContent = IMAGES_READY
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå'
    : `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${__preloadDone}/${__preloadTotal} ...`;
}

/** ‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î ‚Äú‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏°‚Äù ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢) */
function bootPreloadAll(){
  try{
    // === ‡∏£‡∏π‡∏õ ===
    const ALL_IMG_URLS = __collectAllUrls().filter(u => !__imgUrlCache.has(u));

    // === ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ó‡∏∏‡∏Å‡∏î‡πà‡∏≤‡∏ô) ===
    const ALL_VOICE_URLS = [
      ...collectLevelVoiceUrls(1),
      ...collectLevelVoiceUrls(2),
      ...collectLevelVoiceUrls(3),
    ].filter(u => !__audioUrlCache.has(u));

    __preloadDone  = __imgUrlCache.size;
    __preloadTotal = __imgUrlCache.size + ALL_URLS.length;

    if (!ALL_URLS.length){
      IMAGES_READY = true;
      __renderPreloadProgress();
      return;
    }

// preload ‡∏£‡∏π‡∏õ
preloadImages(
  ALL_IMG_URLS,
  (done,total)=>{
    __preloadDone = __imgUrlCache.size;
    __preloadTotal = __imgUrlCache.size + (total - done);
    __renderPreloadProgress();
  },
  ()=>{
    // preload ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI)
    ALL_VOICE_URLS.forEach(warmAudio);

    IMAGES_READY = true;
    __renderPreloadProgress();
  }
);
    __renderPreloadProgress();
  }catch(e){
    IMAGES_READY = true;
  }
}

/** ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏î‡πà‡∏≤‡∏ô‚Äù ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏î‡πà‡∏≤‡∏ô/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) */
function ensurePreloadForLevel(level){
  const urls = collectLevelImageUrls(level).filter(u=>!__imgUrlCache.has(u));
  if (!urls.length) return;
  // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö IMAGES_READY ‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ cache ‡πÄ‡∏â‡∏¢ ‡πÜ
  preloadImages(urls, ()=>{}, ()=>{ /* ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ */ });
}

// ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á DOM ‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ element ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà)
document.addEventListener('DOMContentLoaded', bootPreloadAll);



/* ===== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô ===== */

// ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç N ‡∏à‡∏≤‡∏Å key 'wordN' ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏û‡∏≤‡∏ò‡∏£‡∏π‡∏õ .../wordN.png
function extractWordNumber(qObj){
  // 1) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ imgKey/word/key
  const key = qObj?.imgKey || qObj?.key || qObj?.word || null;
  let m = key ? String(key).match(/word(\d+)/i) : null;
  if (m) return parseInt(m[1],10);

  // 2) ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å path ‡∏£‡∏π‡∏õ
  if (qObj?.img){
    m = String(qObj.img).match(/\/word(\d+)\.[a-z0-9]+$/i);
    if (m) return parseInt(m[1],10);
  }

  // 3) ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‚Üí ‡πÄ‡∏î‡∏≤‡∏™‡∏∏‡πà‡∏° 1..50
  return (1 + ((Math.random()*50)|0));
}

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏≤‡∏ò‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á: level=1 ‡πÉ‡∏ä‡πâ voice1..50 ‡πÉ‡∏ô sound1/
// level=2 ‚Üí voice51..100 ‡πÉ‡∏ô sound2/, level=3 ‚Üí voice101..150 ‡πÉ‡∏ô sound3/
function computeVoicePath(level, wordNum){
  // ‡∏õ‡∏Å‡∏ï‡∏¥ wordNum ‡∏à‡∏∞ 1..50
  const n = Math.max(1, Math.min(50, Number(wordNum)||1));
  let base = 1;   // level 1 ‡πÄ‡∏£‡∏¥‡πà‡∏° 1
  let folder = 'sound1';

  if (level === 2){ base = 51; folder = 'sound2'; }
  else if (level === 3){ base = 101; folder = 'sound3'; }

  // voice index ‡∏à‡∏£‡∏¥‡∏á = base + (n-1)
  const vIndex = base + (n-1);
  // ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ: voiceXX (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ .mp3)
  return `${folder}/voice${vIndex}.mp3`;
}

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô (voiceRel), ‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡πá‡∏° (voiceAbs), ‡∏´‡∏£‡∏∑‡∏≠ fallback ‡∏à‡∏≤‡∏Å wordN
function pickVoiceSrc(level, qObj){
  // 1) voiceAbs: ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ï‡πá‡∏° (1..150)
  if (Number.isFinite(qObj?.voiceAbs)) {
    const abs = Math.max(1, Math.min(150, qObj.voiceAbs|0));
    let folder = 'sound1';
    if (abs >= 101) folder = 'sound3';
    else if (abs >= 51) folder = 'sound2';
    return `${folder}/voice${abs}.mp3`;
  }

  // 2) voiceRel: ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç 1..50 ‡∏Ç‡∏≠‡∏á "‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô"
  if (Number.isFinite(qObj?.voiceRel)) {
    const rel = Math.max(1, Math.min(50, qObj.voiceRel|0));
    let idx = rel;       // L1 base
    let folder = 'sound1';
    if (level === 2){ idx = 50 + rel; folder='sound2'; }   // 51..100
    else if (level === 3){ idx = 100 + rel; folder='sound3'; } // 101..150
    return `${folder}/voice${idx}.mp3`;
  }

  // 3) fallback: ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å wordN ‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  const n = extractWordNumber(qObj);        // 1..50
  return computeVoicePath(level, n);        // map ‡πÑ‡∏õ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô
}

function playQuestionVoiceSmart(level, qObj){
  if (!voiceAudio) return;
  try{
    const src = pickVoiceSrc(level, qObj);
    voiceAudio.pause();
    voiceAudio.currentTime = 0;
const cached = __audioElemCache.get(src);
voiceAudio.src = cached ? cached.src : src;
voiceAudio.currentTime = 0;
voiceAudio.muted = false;
voiceAudio.play()?.catch(()=>{});

  }catch(_){}
}


/* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å key ‡∏ó‡∏µ‡πà ‚Äú‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‚Äù */
function pickWrongKey(level, correctKey){
  const pool = LEVEL_POOLS[level] || new Map();
  const keys = [...pool.keys()].filter(k => k !== correctKey);
  if (!keys.length) return correctKey;
  return keys[(Math.random()*keys.length)|0];
}

/* ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) =====
   qObj = { imgKey: 'word17', ... }
*/
function spawnTwoImageOptions(qObj, level){
  const pool = LEVEL_POOLS[level] || new Map();
  const correctKey = qObj?.imgKey || qObj?.key || qObj?.word || null;

  // ‡πÄ‡∏î‡∏≤ key ‡∏à‡∏≤‡∏Å qObj.img ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô path ‡πÄ‡∏ä‡πà‡∏ô .../word34.png
  let derivedKey = null;
  if (!correctKey && qObj?.img){
    const m = String(qObj.img).match(/\/(word\d+)\.[a-z0-9]+$/i);
    if (m) derivedKey = m[1];
  }
  const finalCorrectKey = correctKey || derivedKey || ('word'+(1+((Math.random()*50)|0)));

  const correctSrc = pool.get(finalCorrectKey) || '';
  const wrongKey   = pickWrongKey(level, finalCorrectKey);
  const wrongSrc   = pool.get(wrongKey) || '';

  // ‡∏™‡∏∏‡πà‡∏°‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏ñ‡∏π‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤
  const order = Math.random()<0.5 ? ['left','right'] : ['right','left'];
  const defs = [
    { ok:true,  side:order[0], src:correctSrc },
    { ok:false, side:order[1], src:wrongSrc   },
  ];

  defs.forEach(def=>{
    const el = document.createElement('div');
    el.className = 'option img in-anim';
    el.dataset.correct = String(!!def.ok);
    el.dataset.side    = def.side;

const im = document.createElement('img');
im.alt = def.ok ? '‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏≠‡∏Å';

// << ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡∏ä‡∏ñ‡πâ‡∏≤‡∏°‡∏µ + ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô decode ‡πÅ‡∏•‡πâ‡∏ß >>
const url = def.src || '';
const cached = __imgElemCache.get(url);
if (cached && cached.complete && cached.naturalWidth > 0){
  im.src = cached.src;
} else {
  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà cache (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏î‡πà‡∏≤‡∏ô) ‚Äî ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ
  warmDecode(url).then(img => { im.src = img.src; }).catch(()=>{ im.src = url; });
}

    el.appendChild(im);
    game.appendChild(el);

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ã‡∏ô‡∏ß‡∏≤‡∏á: ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ ‡πÇ‡∏î‡∏¢‡πÄ‡∏ß‡πâ‡∏ô‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
    const SAFE_PAD = 12;

// === ‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á ‚Äú‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‚Äù ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ===
const prevTransform = el.style.transform;
el.style.transform = 'none';
const cs = getComputedStyle(el);
const realW = parseFloat(cs.width)  || 240;
const realH = parseFloat(cs.height) || 240;
el.style.transform = prevTransform;

// ‡∏Ç‡∏¢‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á: ‡∏ã‡πâ‡∏≤‡∏¢ ~14% ‡∏Ç‡∏ß‡∏≤ ~86% ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≥‡∏•‡∏á‡∏ô‡∏¥‡∏î (~60%)
// ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 0.14 / 0.86 / 0.60 ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à
const SAFE = 12;
const anchor = (side)=>{
  const cx = side === 'left' ? innerWidth * 0.14 : innerWidth * 0.86;
  const cy = innerHeight * 0.60;

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ã‡πâ‡∏≤‡∏¢/‡∏ö‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á + clamp ‡∏Å‡∏±‡∏ô‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö
  let left = Math.round(cx - realW/2);
  let top  = Math.round(cy - realH/2);

  left = Math.max(SAFE, Math.min(innerWidth  - realW - SAFE, left));
  top  = Math.max(SAFE, Math.min(innerHeight - realH - SAFE, top));

  return { left, top };
};
const pos = anchor(def.side);
el.style.left = pos.left + 'px';
el.style.top  = pos.top  + 'px';


    el.addEventListener('click', ()=> tryAnswer(el));

  });

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏û‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏¢‡∏≤‡∏Å‡πÇ‡∏ä‡∏ß‡πå‡∏†‡∏≤‡∏û‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ ‚Äú‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‚Äù)
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏•‡πà‡∏≠‡∏¢ qImg ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
}

/* ===== ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏≠‡∏¢: ‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏Ç‡∏ô‡∏°‡πÅ‡∏ó‡∏ô ===== */
function flyScoreAt(x, y, ok){
  // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á signature ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ‚Äî ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÜ
  if (!ok) return;
  launchEmojiToCorner('top-right'); // ‡∏ó‡∏¥‡∏®‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
}

function flyScoreForEl(el, ok){
  // ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î = ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£
  if (!ok) return;
  // ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å = ‡∏¢‡∏¥‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏õ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 'bottom-right' ‡∏Ø‡∏•‡∏Ø ‡πÑ‡∏î‡πâ)
  launchEmojiToCorner('top-right', 900);
}
/* ===== ‡∏à‡∏ö‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà ===== */


/* ===== Emoji reward (‡∏Ç‡∏ô‡∏°) ===== */
const REWARD_EMOJIS = ['üí∞'];

function pickEmoji(){
  return REWARD_EMOJIS[(Math.random() * REWARD_EMOJIS.length) | 0];
}

/* direction: 'top-right' | 'top-left' | 'bottom-right' | 'bottom-left'
   ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î {x, y} ‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ */
function getTargetDelta(direction='top-right'){
  const margin = 24;
  const cx = innerWidth / 2;
  const cy = innerHeight / 2;

  let tx = innerWidth - margin;
  let ty = margin;

  if (typeof direction === 'object' && direction && Number.isFinite(direction.x) && Number.isFinite(direction.y)){
    tx = direction.x; ty = direction.y;
  } else {
    switch (direction){
      case 'top-left':     tx = margin;            ty = margin;            break;
      case 'bottom-right': tx = innerWidth-margin; ty = innerHeight-margin;break;
      case 'bottom-left':  tx = margin;            ty = innerHeight-margin;break;
      case 'top-right':
      default:             tx = innerWidth-margin; ty = margin;            break;
    }
  }
  return { dx: tx - cx, dy: ty - cy };
}

function launchEmojiToCorner(direction='top-right', durationMs=900){
  const el = document.createElement('div');
  el.className = 'fly-emoji';
  el.textContent = pickEmoji();

  const {dx, dy} = getTargetDelta(direction);
  el.style.setProperty('--dx', dx + 'px');
  el.style.setProperty('--dy', dy + 'px');
  el.style.setProperty('--emoji-ms', durationMs + 'ms');

  document.body.appendChild(el);
  // trigger animation in next frame
  requestAnimationFrame(()=> el.classList.add('go'));
  el.addEventListener('animationend', ()=> el.remove(), {once:true});
}
/* ===== end Emoji reward ===== */


/* === [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏î‡πà‡∏≤‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• === */
const GAME_DURATION_MS = 120000; // 2 ‡∏ô‡∏≤‡∏ó‡∏µ
let gameTimerId = null;
let gameEndAt = 0;
let remainingMs = GAME_DURATION_MS;

function clearGameTimer(){
  if (gameTimerId){ clearTimeout(gameTimerId); gameTimerId = null; }
}

function scheduleGameTimer(ms){
  clearGameTimer();
  gameTimerId = setTimeout(()=>{
    // ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚Üí ‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
    if(!ended){ endLevel(); }
  }, Math.max(0, ms|0));
}

function startGameTimer(){
  remainingMs = GAME_DURATION_MS;
  gameEndAt = performance.now() + remainingMs;
  scheduleGameTimer(remainingMs);
startClockUI();     // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°
}

function pauseGameTimer(){
  if (gameTimerId){
    remainingMs = Math.max(0, gameEndAt - performance.now());
    clearGameTimer();
       pauseClockUI();     // ‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÉ‡∏ä‡πâ remainingMs ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
  }
}

function resumeGameTimer(){
  if (remainingMs > 0 && !ended){
    gameEndAt = performance.now() + remainingMs;
    scheduleGameTimer(remainingMs);
        resumeClockUI();    // ‡πÄ‡∏î‡∏¥‡∏ô‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ï‡πà‡∏≠
  }
}

  const BLANK_MS=800, Q_DROP_MS=600, Q_HOLD_MS=400, OPT_IN_MS=200, RESULT_MS=1000;
  let running=false, ended=false, paused=false;
  window.ended = ended; // ‚úÖ sync ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á global
  let score=0, round=0;
  let roundTimer=null, timeLeft=0, awaitingAnswer=false;
// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏Å‡πá‡∏ö timeout ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏î‡πà‡∏≤‡∏ô
let nextRoundTO1 = null;
let nextRoundTO2 = null;
let preloadWaitId = null;   // (‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ô startGame() ‡∏¢‡∏¥‡∏á‡πÄ‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏£‡∏≠ preload)


// === ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Tap-to-continue) ===
let gateOpen = false;
let afterRoundTimeoutId = null;  // ‚¨Ö ‡πÄ‡∏Å‡πá‡∏ö timeout ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å spawnContinueEmojis

function cancelPostRoundPhase(){
  gateOpen = false;
  if (afterRoundTimeoutId){
    clearTimeout(afterRoundTimeoutId);
    afterRoundTimeoutId = null;
  }
  clearContinueEmojis();  // ‡∏•‡∏ö‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà
}

const BONUS_EMOJIS = ['üåà','üí∞','ü™ô','üíµ','üìñ','üéÅ','üéÉ','üß∏','üèÜ','üé∑','üéì','üëë'];

function spawnContinueEmojis(n=1){
  // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà in-game ‚Üí ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
  if (ended || !document.body.classList.contains('in-game')) return;

  clearContinueEmojis();
  gateOpen = true;

  const PADDING = 12;            // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
  const HOLE_W_PCT = 0.40;       // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (40% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠)
  const HOLE_H_PCT = 0.34;       // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏£‡∏π‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (34% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠)
  const triesMax   = 60;
  const holeW = Math.floor(innerWidth  * HOLE_W_PCT);
  const holeH = Math.floor(innerHeight * HOLE_H_PCT);
  const holeX = Math.floor((innerWidth  - holeW)/2);
  const holeY = Math.floor((innerHeight - holeH)/2);
  const holeRect = { x: holeX, y: holeY, w: holeW, h: holeH };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡∏Å‡∏•‡πà‡∏≠‡∏á A ‡∏Å‡∏±‡∏ö B ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°
  const rectsOverlap = (ax,ay,aw,ah, bx,by,bw,bh) =>
    (ax < bx + bw) && (ax + aw > bx) && (ay < by + bh) && (ay + ah > by);

  for (let i=0; i<n; i++){
    const e = document.createElement('div');
e.className = 'tap-target glow';
    e.textContent = BONUS_EMOJIS[(Math.random()*BONUS_EMOJIS.length)|0];

    // ‡∏ß‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á
    e.style.left = '-9999px';
    e.style.top  = '-9999px';
    document.body.appendChild(e);

    const r = e.getBoundingClientRect();
    const w = r.width, h = r.height;

    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏•‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
    const minX = PADDING;
    const maxX = Math.max(PADDING, innerWidth  - PADDING - w);
    const minY = PADDING;
    const maxY = Math.max(PADDING, innerHeight - PADDING - h);

    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚Üí ‡∏´‡∏î‡∏£‡∏π‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    const holeTooWide  = (holeW >= (innerWidth  - PADDING*2 - w));
    const holeTooTall  = (holeH >= (innerHeight - PADDING*2 - h));
    const useHole = !(holeTooWide || holeTooTall);

    let x=0, y=0, ok=false, tries=0;
    while (tries++ < triesMax){
      x = Math.round(minX + Math.random() * (maxX - minX));
      y = Math.round(minY + Math.random() * (maxY - minY));

      if (!useHole){
        ok = true; // ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏ô‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏π
      }else{
        ok = !rectsOverlap(x,y,w,h, holeRect.x, holeRect.y, holeRect.w, holeRect.h);
      }
      if (ok) break;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏£‡∏π‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí ‚Äú‡∏î‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‚Äù ‡πÑ‡∏õ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏£‡∏π‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î
    if (!ok && useHole){
      // ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥
      const cx = x + w/2, cy = y + h/2;
      const hx1 = holeRect.x, hx2 = holeRect.x + holeRect.w;
      const hy1 = holeRect.y, hy2 = holeRect.y + holeRect.h;

      // ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á 4 ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏π ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏¥‡∏®‡∏ô‡∏±‡πâ‡∏ô
      const dxL = Math.abs(cx - hx1);
      const dxR = Math.abs(hx2 - cx);
      const dyT = Math.abs(cy - hy1);
      const dyB = Math.abs(hy2 - cy);

      const minD = Math.min(dxL, dxR, dyT, dyB);
      if (minD === dxL) x = hx1 - w - 1;        // ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏π
      else if (minD === dxR) x = hx2 + 1;       // ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏π
      else if (minD === dyT) y = hy1 - h - 1;   // ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏π
      else                   y = hy2 + 1;       // ‡∏î‡∏±‡∏ô‡∏•‡∏á‡πÉ‡∏ï‡πâ‡∏£‡∏π

      // ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ clamp ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
      x = Math.max(minX, Math.min(maxX, x));
      y = Math.max(minY, Math.min(maxY, y));
    }

    e.style.left = x + 'px';
    e.style.top  = y + 'px';
    e.addEventListener('click', () => {
      playSfx(eatSound, VOL_EAT);
    e.classList.add('disappear');
      // ‡∏£‡∏≠‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö 320ms ‡πÉ‡∏ô CSS)
      setTimeout(() => {
        e.remove();
        proceedNextRound();   
      }, 320);
    }, { once:true });
  }
}

function clearContinueEmojis(){
  document.querySelectorAll('.tap-target').forEach(n=> n.remove());
}

function proceedNextRound(){
  if (!gateOpen) return;
  gateOpen = false;

  // ‚úÖ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà = ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  score += 1;
  updateHUD();

  clearContinueEmojis();
  nextRound();
}

  let driftTimers = [];
  function clearDrifts(){ driftTimers.forEach(id=>clearInterval(id)); driftTimers=[]; }
  function clearRoundObjects(){ 
          clearDrifts(); document.querySelectorAll('.option').forEach(n=>n.remove()); 
}

function restorePlayfield(){
  game.style.visibility = 'visible';
  qBox.style.display    = 'block';
}

function freezePlayfield(on){
  awaitingAnswer = false;           // ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏ï‡πà‡∏≠
  stopTimebar();                    // ‡∏Å‡∏±‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  clearRoundObjects();              // ‡∏•‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏° + ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå interval ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà
  // ‡∏ã‡πà‡∏≠‡∏ô/‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ
  qBox.textContent = '';
  qBox.style.display = on ? 'none' : 'block';
  if (qImg){
    qImg.style.display = on ? 'none' : 'block';
    if(on) qImg.removeAttribute('src');
  }
  game.style.visibility = on ? 'hidden' : 'visible';
}

  function updateHUD(){ renderGold(score); 
}

function resetState(){ 
    clearCountdown();
   cancelPostRoundPhase();   // ‡∏Å‡∏±‡∏ô timeout ‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô
  running = false;
  ended   = true;
  window.ended = ended;
  paused  = false;

  clearRoundObjects();
  clearGameTimer();
  if (roundTimer){ clearInterval(roundTimer); roundTimer = null; }
  document.body.classList.remove('in-game');
  score = 0;
  round = 0;
  timeLeft = 0;
  awaitingAnswer = false;
  updateHUD();

  qBox.textContent = '';
  qBox.style.top = '-160px';
  qBox.style.display = 'none';
  if (qImg) {
    qImg.style.display = 'none';
    qImg.removeAttribute('src');
  }

  stopTimebar();
  resetClockUI();
  game.style.visibility = 'visible';   // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡πÄ‡∏Å‡∏°
}

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠+‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô)
function hardCleanupNow({ stopBgm = true } = {}){
  // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏•‡πâ‡∏≤‡∏á countdown ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà (‡∏Å‡∏±‡∏ô startGame ‡∏¢‡∏¥‡∏á‡πÄ‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π)
  clearCountdown();
  if (nextRoundTO1){ clearTimeout(nextRoundTO1); nextRoundTO1 = null; }
  if (nextRoundTO2){ clearTimeout(nextRoundTO2); nextRoundTO2 = null; }
  if (preloadWaitId){ clearInterval(preloadWaitId); preloadWaitId = null; }

  // 1) ‡∏ï‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  awaitingAnswer = false;
  gateOpen = false;
  running = false;
  paused = false;
  ended = true;
  window.ended = true;


  // 2) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timer/interval/timeout ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≠‡∏ö
  cancelPostRoundPhase();        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå afterRoundTimeoutId + ‡∏•‡∏ö tap-target
  clearGameTimer();              // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå setTimeout ‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ
  if (roundTimer){ clearInterval(roundTimer); roundTimer = null; }
  clearDrifts();                 // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå setInterval ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢

  // 3) ‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏∏‡∏î!)
  document.querySelectorAll('.option, .tap-target, .fly-emoji').forEach(n=> n.remove());

  // 4) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå UI ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏≤‡∏° ‚Äú‡∏™‡∏∞‡∏≠‡∏≤‡∏î‚Äù
  qBox.textContent = '';
  qBox.style.display = 'none';
  qBox.style.visibility = 'hidden';
  qBox.classList.remove('in-pre','in-go','out-left','out-right','fx');

  if (qImg){
    qImg.onload = null;
    qImg.onerror = null;
    qImg.removeAttribute('src');
    qImg.style.display = 'none';
    qImg.classList.remove('in-pre','in-go','out-left','out-right','fx');
  }

  stopTimebar();
  stopClockUI();
  resetClockUI();

  // 5) ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏£‡∏ß‡∏° voice ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô)
  const audios = [voiceAudio, hitSound, winSound, selectSound, eatSound, wrongSound, bgm];
  audios.forEach(a=>{
    try{
      if(!a) return;
      a.pause();
      a.currentTime = 0;
    }catch(_){}
  });

  // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏™‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ BGM ‡∏î‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π ‡πÉ‡∏´‡πâ stopBgm=false ‡πÑ‡∏î‡πâ
  if (!stopBgm && bgm){
    try{ bgm.play().catch(()=>{}); }catch(_){}
  }

  // 6) ‡∏ñ‡∏≠‡∏î class ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏≠‡∏≠‡∏Å
  document.body.classList.remove('in-game');
  document.body.classList.remove('prestart');

  // 7) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏≤‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô/‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á hidden (‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏ô game ‡πÑ‡∏ß‡πâ)
  game.style.visibility = 'visible';
}


  function showToast(payload){
    const ansImg = document.getElementById('ansImg');
    const data = (typeof payload === 'object' && payload) ? payload : { q:String(payload||''), a:'', ok:false };
    const { q='', a='', ok=false } = data;
    const esc = (s)=> String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    toast.innerHTML = `<span class="q">${esc(q)}</span><span class="a">${esc(a||'‚Äî')}</span><span class="r ${ok?'ok':'bad'}">${ok?'‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á':'‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'}</span>`;
    toast.style.display='inline-block';
    if(ansImg){ ansImg.onerror=()=>{ansImg.style.display='none'}; ansImg.src='image/ans1.png'; ansImg.style.display='block'; }
    const playFlashIn = (el,cover=false)=>{ if(!el)return; el.classList.remove('flash-in','flash-in-cover'); void el.offsetWidth; el.classList.add(cover?'flash-in-cover':'flash-in'); el.addEventListener('animationend',()=>el.classList.remove('flash-in','flash-in-cover'),{once:true}); };
    playFlashIn(ansImg,true); playFlashIn(toast,false);
    setTimeout(()=>{ toast.style.display='none'; if(ansImg) ansImg.style.display='none'; }, RESULT_MS);
  }

// ‡∏ï‡∏±‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
function startTimebar(){}                 // no-op
function stopTimebar(){}                  // no-op
function updateTimebar(){}                // no-op

function dropQuestion(text, imgSrc){
  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  qBox.textContent = String(text);

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô
  qBox.style.transition = '';
  qImg.style.transition = '';
  qBox.style.opacity = '';
  qImg.style.opacity = '';
  qBox.style.pointerEvents = 'auto';
  qBox.style.top = 'var(--qTop)';
  qBox.style.display = 'block';

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°
  qBox.style.visibility = 'hidden';

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™ FX
  qBox.classList.remove('out-left','out-right','in-go','in-pre');
  qImg.classList.remove('out-left','out-right','in-go','in-pre');
  qImg.classList.add('fx','in-pre');   // qBox ‡πÑ‡∏°‡πà‡∏°‡∏µ fx/in-pre ‡πÅ‡∏•‡πâ‡∏ß

  // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  if (qImg){
    if (imgSrc){
      qImg.style.display = 'none';

      const startIn = () => {
        qImg.style.display = 'block';
        qBox.style.visibility = 'visible';  // ‚úÖ ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
        requestAnimationFrame(() => {
          // ‡πÉ‡∏™‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ (‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ qBox ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢)
          qImg.classList.add('in-go');
          // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà in-go ‡πÉ‡∏´‡πâ qBox
          // qBox.classList.add('in-go');
        });
      };
      const textOnly = () => {
        qImg.style.display = 'none';
        qBox.style.visibility = 'visible';   // ‚úÖ ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏°‡∏≤ ‡πÅ‡∏ï‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á ‡πÜ ‡∏Å‡πá‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ in-go
        // requestAnimationFrame(() => qBox.classList.add('in-go'));
      };

qImg.onload  = startIn;
qImg.onerror = textOnly;

// ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/Decode ‡πÉ‡∏´‡∏°‡πà)
const cached = __imgElemCache.get(imgSrc);
if (cached && cached.complete && cached.naturalWidth > 0){
  qImg.src = cached.src;
  // ‡∏ö‡∏≤‡∏á‡∏ö‡∏£‡∏≤‡∏ß‡πÄ‡∏ã‡∏≠‡∏£‡πå onload ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ src ‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å startIn ‡πÄ‡∏≠‡∏á
  if (qImg.complete && qImg.naturalWidth > 0) startIn();
} else {
  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏ö‡∏ö async ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡πâ‡∏á src
  warmDecode(imgSrc).then(img=>{
    qImg.src = img.src;
    if (qImg.complete && qImg.naturalWidth > 0) startIn();
  }).catch(()=>{
    qImg.src = imgSrc;
  });
}

      if (qImg.complete && qImg.naturalWidth > 0) startIn();
} else {
  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‚Üí ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏±‡∏ö qBox
  qImg.style.display = 'none';
  qImg.removeAttribute('src');

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏Ñ‡∏•‡∏≤‡∏™ FX ‡πÉ‡∏´‡πâ qBox
  qBox.classList.remove('fx','in-pre','in-go','out-left','out-right');
  qBox.classList.add('fx','in-pre');
  qBox.style.visibility = 'visible';

  requestAnimationFrame(() => {
    qBox.classList.add('in-go');     // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡πÄ‡∏ü‡∏î/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢
  });
}

  }
}

  /* ---------- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ ---------- */
  function clearOptionGlows(){ document.querySelectorAll('.option.circle.glow').forEach(n=>n.classList.remove('glow')); }
  function glowGold(el){ if(!el) return; el.classList.add('glow'); }
  function spawnTwoCircles(correctTag /* 'living'|'non' */){
    const SIDE_W = innerWidth / 3;
    const PAD = 16;
    const order = Math.random()<0.5 ? ['left','right'] : ['right','left'];
    const defs = [
      { key:'non',    text:'‡∏™‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï', cls:'non',  side:order[0] },
      { key:'living', text:'‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï',     cls:'live', side:order[1] },
    ];
    defs.forEach(def=>{
      const el = document.createElement('div');
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ in-anim ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤
            el.className = `option circle ${def.cls} in-anim`;

      el.dataset.correct = String(def.key === correctTag);
      el.dataset.side = def.side; 
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = def.text;
      el.appendChild(label);
      game.appendChild(el);

// ===== ‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô transform ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ß‡∏≤‡∏á =====
const SAFE_PAD = 12; // ‡∏Ç‡∏≠‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏£‡∏≠‡∏ö‡∏à‡∏≠

// ‡∏ñ‡∏≠‡∏î transform ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á
const prevTransform = el.style.transform;
el.style.transform = 'none';

const cs = getComputedStyle(el);
const core = parseFloat(cs.getPropertyValue('--c-sz')) || parseFloat(cs.width) || 180;
const border =
  (parseFloat(cs.borderLeftWidth)  || 0) +
  (parseFloat(cs.borderRightWidth) || 0);

// ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ scale(1)
const realSize = Math.round(core + border);

// ‡∏Ñ‡∏∑‡∏ô transform ‡πÄ‡∏î‡∏¥‡∏° + ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ in-anim ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
el.style.transform = prevTransform;

// ‡πÇ‡∏ã‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (‡∏Å‡∏±‡∏ô‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)
const yMin = 110;
const yMax = Math.max(140, innerHeight - realSize - SAFE_PAD);

// ‡πÇ‡∏ã‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‡πÅ‡∏ö‡∏ö ‚Äú‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1/3 ‡∏à‡∏≠‚Äù ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏ô
const totalMaxX = innerWidth - realSize - SAFE_PAD;

// ‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏à‡∏ö‡πÇ‡∏ã‡∏ô 1/3 ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤
const leftZoneStart  = SAFE_PAD;
const leftZoneEnd    = Math.max(SAFE_PAD, Math.min(totalMaxX, (innerWidth / 3) - SAFE_PAD));

const rightZoneStart = Math.max(SAFE_PAD, Math.min(totalMaxX, Math.ceil((innerWidth * 2) / 3)));
const rightZoneEnd   = totalMaxX;

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏≤‡∏°‡∏ù‡∏±‡πà‡∏á
let xMin, xMax;
if (def.side === 'left') {
  xMin = leftZoneStart;
  xMax = leftZoneEnd - realSize; // ‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á
} else {
  xMin = rightZoneStart;
  xMax = rightZoneEnd;
}

// ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏Ñ‡∏ö‡∏à‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‚Üí ‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠
if (!isFinite(xMin) || !isFinite(xMax) || xMin > xMax) {
  xMin = SAFE_PAD;
  xMax = totalMaxX;
}

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
const nx0 = Math.round(xMin + Math.random() * Math.max(0, xMax - xMin));
const ny0 = Math.round(yMin + Math.random() * Math.max(0, yMax - yMin));
el.style.left = nx0 + 'px';
el.style.top  = ny0 + 'px';

// ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
const id = setInterval(() => {
  const nx = Math.round(xMin + Math.random() * Math.max(0, xMax - xMin));
  const ny = Math.round(yMin + Math.random() * Math.max(0, yMax - yMin));
  el.style.left = nx + 'px';
  el.style.top  = ny + 'px';
}, 3000 + Math.random() * 1300);
driftTimers.push(id);


      el.addEventListener('click', ()=> tryAnswer(el));
    });
  }

  // ===== [LEVEL 1] ‡∏ß‡∏á‡∏Å‡∏•‡∏° 2 ‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠ =====
function spawnTwoAnswerCircles(choices, correctIndex){
  const order = Math.random()<0.5 ? ['left','right'] : ['right','left'];
  const defs = [
    { idx:0, text: choices[0], side: order[0], cls:'choiceA' },
    { idx:1, text: choices[1], side: order[1], cls:'choiceB' },
  ];
  defs.forEach(def=>{
    const el = document.createElement('div');
    el.className = `option circle in-anim ${def.cls}`;  // << ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏≤‡∏™ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ style.border
    el.dataset.side = def.side;
    el.dataset.correct = String(def.idx === correctIndex);
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = def.text;
    el.appendChild(label);
    game.appendChild(el);

    // ===== ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) =====
    const SAFE_PAD = 12;
    const prevTransform = el.style.transform;
    el.style.transform = 'none';
    const cs = getComputedStyle(el);
    const core = parseFloat(cs.getPropertyValue('--c-sz')) || parseFloat(cs.width) || 180;
    const border = (parseFloat(cs.borderLeftWidth)||0)+(parseFloat(cs.borderRightWidth)||0);
    const realSize = Math.round(core + border);
    el.style.transform = prevTransform;

    const yMin = 110;
    const yMax = Math.max(140, innerHeight - realSize - SAFE_PAD);
    const totalMaxX = innerWidth - realSize - SAFE_PAD;

    const leftZoneStart  = SAFE_PAD;
    const leftZoneEnd    = Math.max(SAFE_PAD, Math.min(totalMaxX, (innerWidth / 3) - SAFE_PAD));
    const rightZoneStart = Math.max(SAFE_PAD, Math.min(totalMaxX, Math.ceil((innerWidth * 2) / 3)));
    const rightZoneEnd   = totalMaxX;

    let xMin, xMax;
    if (def.side === 'left'){ xMin = leftZoneStart; xMax = leftZoneEnd - realSize; }
    else { xMin = rightZoneStart; xMax = rightZoneEnd; }
    if (!isFinite(xMin) || !isFinite(xMax) || xMin > xMax){ xMin = SAFE_PAD; xMax = totalMaxX; }

    const nx0 = Math.round(xMin + Math.random() * Math.max(0, xMax - xMin));
    const ny0 = Math.round(yMin + Math.random() * Math.max(0, yMax - yMin));
    el.style.left = nx0 + 'px';
    el.style.top  = ny0 + 'px';

    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á
    // (‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å setInterval ‡πÄ‡∏î‡∏¥‡∏°)

    el.addEventListener('click', ()=> tryAnswer(el));
  });
}


function tryAnswer(el){
    if (ended) return;   // ‚ùó ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏ï‡∏≠‡∏ö
  if(!awaitingAnswer) return;
const ok = (el.dataset.correct === 'true');
awaitingAnswer = false;

// üî∏ ‡πÉ‡∏´‡πâ "‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" fade ‡∏´‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
document.querySelectorAll('.option').forEach(btn=>{
// üîä ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏ï‡∏≠‡∏ô "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"
try{
  if (ok) {
    playSfx(hitSound, VOL_HIT);        // ‡∏ñ‡∏π‡∏Å ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏¥‡∏° (hitSound)
  } else {
    playSfx(wrongSound, VOL_WRONG);     // ‡∏ú‡∏¥‡∏î ‚Üí ‡πÄ‡∏•‡πà‡∏ô image/wrong.mp3
  }
}catch(_){}

  btn.classList.add('fade-out');
  btn.addEventListener('animationend', ()=> btn.remove(), {once:true});
});

// (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏ö‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ)


  // ===== NEW: ‡∏™‡πÑ‡∏•‡∏î‡πå qBox + qImg ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß "‡∏£‡∏≠" ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô =====
  const side = el.dataset.side || ((el.getBoundingClientRect().left < innerWidth/2) ? 'left' : 'right');

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏Å
  qBox.classList.remove('in-pre','in-go','out-left','out-right');
  qImg.classList.remove('in-pre','in-go','out-left','out-right');
  qBox.classList.add('fx', side==='left' ? 'out-left' : 'out-right');
  qImg.classList.add('fx', side==='left' ? 'out-left' : 'out-right');

  // ‡∏£‡∏≠ transition ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á qBox ‡πÅ‡∏•‡∏∞ qImg (‡∏°‡∏µ timeout ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
  waitForBothTransitions([qBox, qImg], 600).then(()=>{
    // ‡∏à‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≠‡∏ö
    endRound(ok, el, false);
  });

  // (‡∏ï‡∏±‡∏î selectSound ‡∏≠‡∏≠‡∏Å ‚Äî ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
}

/* Helper: ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å element ‡∏à‡∏∞‡∏¢‡∏¥‡∏á 'transitionend' ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏ö timeout (ms) */
function waitForBothTransitions(els, timeoutMs=600){
  const once = (node, type) => new Promise(res=>{
    let done=false;
    const h = ()=>{ if(!done){ done=true; node.removeEventListener(type,h); res(); } };
    node.addEventListener(type, h, {once:true});
    // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ transition ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏°
    setTimeout(h, timeoutMs);
  });
  return Promise.all( (els||[]).map(n=> once(n,'transitionend')) );
}


function endRound(ok, pickedElOrNull, timeout=false){
  clearInterval(roundTimer); stopTimebar();
  // (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô hitSound ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)


  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏≠‡∏¢
if (ok) {
  score += 2;     // ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å +1
} else {
  score -= 2;     // ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î -1
}
updateHUD();
flyScoreForEl(pickedElOrNull || null, ok); // ‡πÅ‡∏™‡∏î‡∏á +1/-1 ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°

// ‡πÄ‡∏Å‡πá‡∏ö timeout id ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏Å‡∏°
afterRoundTimeoutId = setTimeout(()=>{
  // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°/‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥
  if (ended || !document.body.classList.contains('in-game')) return;

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏ß‡∏≤‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°
  const hide = (el)=>{ if(!el) return; el.style.transition='none'; el.style.opacity='0'; el.style.pointerEvents='none'; };
  hide(qBox);
  document.querySelectorAll('.option').forEach(hide);
  timebarWrap.style.opacity='0';

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡πÅ‡∏ï‡πà "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà" ‡πÑ‡∏õ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
  clearRoundObjects(); 
  qBox.textContent=''; 
  qBox.style.opacity='1'; 
  timebarWrap.style.opacity='1';

  round++; updateHUD();
  if(qImg){ qImg.style.display='none'; qImg.removeAttribute('src'); }

  // ‚òÖ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞ nextRound() ‡πÄ‡∏•‡∏¢ ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î ‚Äú‡πÄ‡∏Å‡∏ó‚Äù ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥
  spawnContinueEmojis(1);   // ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ
}, 600);


}


 /* ---------‡∏ú‡∏π‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û--------- */
const FIXED_IMG_MAP = {};

/* ===== [LEVEL 1] ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö ‚Äú‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£?‚Äù 2 ‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå =====
   ‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏≠‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å FIXED_IMG_MAP ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ prompt
   choices: [‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ß‡∏≤], correct: index ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å (0 ‡∏´‡∏£‡∏∑‡∏≠ 1)
*/
const NEEDS_BANK = [
  { prompt:'sandwich',       imgKey:'word1',  voiceRel: 1  },
  { prompt:'french fries',   imgKey:'word2',  voiceRel: 2  },
  { prompt:'burger',               imgKey:'word3',  voiceRel: 3  },
  { prompt:'salad',                 imgKey:'word4',  voiceRel: 4  },
  { prompt:'rice',         imgKey:'word5',  voiceRel: 5  },
  { prompt:'fried egg',          imgKey:'word6',  voiceRel: 6  },
  { prompt:'sausage',         imgKey:'word7',  voiceRel: 7  },
  { prompt:'omelet',            imgKey:'word8',  voiceRel: 8  },
  { prompt:'bread',         imgKey:'word9',  voiceRel: 9  },
  { prompt:'bacon',                   imgKey:'word10', voiceRel: 10 },
  { prompt:'fried chicken',       imgKey:'word11', voiceRel: 11 },
  { prompt:'fish',           imgKey:'word12', voiceRel: 12 },
  { prompt:'noodles',          imgKey:'word13', voiceRel: 13 },
  { prompt:'pizza',       imgKey:'word14', voiceRel: 14 },
  { prompt:'spaghetti',           imgKey:'word15', voiceRel: 15 },
  { prompt:'beef',            imgKey:'word16', voiceRel: 16 },
  { prompt:'pork',          imgKey:'word17', voiceRel: 17 },
  { prompt:'crisps',            imgKey:'word18', voiceRel: 18 },
  { prompt:'cookie',       imgKey:'word19', voiceRel: 19 },
  { prompt:'pancake',             imgKey:'word20', voiceRel: 20 },
  { prompt:'milk',        imgKey:'word21', voiceRel: 21 },
  { prompt:'yogurt',         imgKey:'word22', voiceRel: 22 },
  { prompt:'water',           imgKey:'word23', voiceRel: 23 },
  { prompt:'popcorn',         imgKey:'word24', voiceRel: 24 },
  { prompt:'butter',          imgKey:'word25', voiceRel: 25 },
  { prompt:'ice cream',            imgKey:'word26', voiceRel: 26 },
  { prompt:'cake',            imgKey:'word27', voiceRel: 27 },
  { prompt:'chocolate',           imgKey:'word28', voiceRel: 28 },
  { prompt:'juice',           imgKey:'word29', voiceRel: 29 },
  { prompt:'candy',           imgKey:'word30', voiceRel: 30 },
  { prompt:'ketchup',           imgKey:'word31', voiceRel: 31 },
  { prompt:'soup',           imgKey:'word32', voiceRel: 32 },
  { prompt:'papaya salad',           imgKey:'word33', voiceRel: 33 },
  { prompt:'donut',           imgKey:'word34', voiceRel: 34 },
  { prompt:'flour',           imgKey:'word35', voiceRel: 35 },
  { prompt:'sugar',           imgKey:'word36', voiceRel: 36 },
  { prompt:'salt',           imgKey:'word37', voiceRel: 37 },
];

const LEVEL1_BANK = [
  { prompt:'stomach ache',      imgKey:'word1',  voiceRel: 1  },
  { prompt:'toothache',       imgKey:'word2',  voiceRel: 2  },
  { prompt:'sore throat',       imgKey:'word3',  voiceRel: 3  },
  { prompt:'headache',     imgKey:'word4',  voiceRel: 4  },
  { prompt:'fever',            imgKey:'word5',  voiceRel: 5  },
  { prompt:'cough',            imgKey:'word6',  voiceRel: 6  },
  { prompt:'rash',         imgKey:'word7',  voiceRel: 7  },
  { prompt:'broken arm',  imgKey:'word8',  voiceRel: 8  },
  { prompt:'broken leg',  imgKey:'word9',  voiceRel: 9  },
  { prompt:'diarrhea',      imgKey:'word10', voiceRel: 10 },
  { prompt:'vomit',       imgKey:'word11', voiceRel: 11 },
  { prompt:'cut',            imgKey:'word12', voiceRel: 12 },
  { prompt:'bruised',     imgKey:'word13', voiceRel: 13 },
  { prompt:'runny nose',  imgKey:'word14', voiceRel: 14 },
  { prompt:'cold',        imgKey:'word15', voiceRel: 15 },
];

const LEVEL2_BANK = [
  { prompt:'sandwich',       imgKey:'word1',  voiceRel: 1  },
  { prompt:'french fries',   imgKey:'word2',  voiceRel: 2  },
  { prompt:'burger',               imgKey:'word3',  voiceRel: 3  },
  { prompt:'salad',                 imgKey:'word4',  voiceRel: 4  },
  { prompt:'rice',         imgKey:'word5',  voiceRel: 5  },
  { prompt:'fried egg',          imgKey:'word6',  voiceRel: 6  },
  { prompt:'sausage',         imgKey:'word7',  voiceRel: 7  },
  { prompt:'omelet',            imgKey:'word8',  voiceRel: 8  },
  { prompt:'bread',         imgKey:'word9',  voiceRel: 9  },
  { prompt:'bacon',                   imgKey:'word10', voiceRel: 10 },
  { prompt:'fried chicken',       imgKey:'word11', voiceRel: 11 },
  { prompt:'fish',           imgKey:'word12', voiceRel: 12 },
  { prompt:'noodles',          imgKey:'word13', voiceRel: 13 },
  { prompt:'pizza',       imgKey:'word14', voiceRel: 14 },
  { prompt:'spaghetti',           imgKey:'word15', voiceRel: 15 },
  { prompt:'beef',            imgKey:'word16', voiceRel: 16 },
  { prompt:'pork',          imgKey:'word17', voiceRel: 17 },
  { prompt:'crisps',            imgKey:'word18', voiceRel: 18 },
  { prompt:'cookie',       imgKey:'word19', voiceRel: 19 },
  { prompt:'pancake',             imgKey:'word20', voiceRel: 20 },
  { prompt:'milk',        imgKey:'word21', voiceRel: 21 },
  { prompt:'yogurt',         imgKey:'word22', voiceRel: 22 },
  { prompt:'water',           imgKey:'word23', voiceRel: 23 },
  { prompt:'popcorn',         imgKey:'word24', voiceRel: 24 },
  { prompt:'butter',          imgKey:'word25', voiceRel: 25 },
  { prompt:'ice cream',            imgKey:'word26', voiceRel: 26 },
  { prompt:'cake',            imgKey:'word27', voiceRel: 27 },
  { prompt:'chocolate',           imgKey:'word28', voiceRel: 28 },
  { prompt:'juice',           imgKey:'word29', voiceRel: 29 },
  { prompt:'candy',           imgKey:'word30', voiceRel: 30 },
  { prompt:'ketchup',           imgKey:'word31', voiceRel: 31 },
  { prompt:'soup',           imgKey:'word32', voiceRel: 32 },
  { prompt:'papaya salad',           imgKey:'word33', voiceRel: 33 },
  { prompt:'donut',           imgKey:'word34', voiceRel: 34 },
  { prompt:'flour',           imgKey:'word35', voiceRel: 35 },
  { prompt:'sugar',           imgKey:'word36', voiceRel: 36 },
  { prompt:'salt',           imgKey:'word37', voiceRel: 37 },
];

const LEVEL3_BANK = [
  { prompt:'bank',        imgKey:'word1',  voiceRel: 1  },
  { prompt:'school',        imgKey:'word2',  voiceRel: 2  },
  { prompt:'police station',       imgKey:'word3',  voiceRel: 3  },
  { prompt:'gas station',       imgKey:'word4', voiceRel: 4  },
  { prompt:'church',     imgKey:'word5',  voiceRel: 5  },
  { prompt:'hospital',   imgKey:'word6',  voiceRel: 6  },
  { prompt:'forest',      imgKey:'word7',  voiceRel: 7  },
  { prompt:'coffee shop',       imgKey:'word8',  voiceRel: 8  },
  { prompt:'market',       imgKey:'word9',  voiceRel: 9  },
  { prompt:'shopping mall',     imgKey:'word10', voiceRel: 10 },
  { prompt:'cinema',        imgKey:'word11', voiceRel: 11 },
  { prompt:'sea',        imgKey:'word12', voiceRel: 12 },
  { prompt:'beach',      imgKey:'word13', voiceRel: 13 },
  { prompt:'museum',       imgKey:'word14', voiceRel: 14 },
  { prompt:'zoo',      imgKey:'word15', voiceRel: 15 },
  { prompt:'river',          imgKey:'word16', voiceRel: 16 },
  { prompt:'desert',       imgKey:'word17', voiceRel: 17 },
  { prompt:'park',       imgKey:'word18', voiceRel: 18 },
  { prompt:'fire station',      imgKey:'word19', voiceRel: 19 },
  { prompt:'temple',     imgKey:'word20', voiceRel: 20 },
  { prompt:'theme park',          imgKey:'word21', voiceRel: 21 },
  { prompt:'library',    imgKey:'word22', voiceRel: 22 },
  { prompt:'hotel',      imgKey:'word23', voiceRel: 23 },
  { prompt:'restaurant',   imgKey:'word24', voiceRel: 24 },
  { prompt:'train station',    imgKey:'word25', voiceRel: 25 },
  { prompt:'airport',        imgKey:'word26', voiceRel: 26 },
  { prompt:'stadium',        imgKey:'word27', voiceRel: 27 },
  { prompt:'mountain',        imgKey:'word28', voiceRel: 28 },
  { prompt:'volcano',       imgKey:'word29', voiceRel: 29 },
  { prompt:'aquarium',  imgKey:'word30', voiceRel: 30 },
  { prompt:'house',      imgKey:'word31', voiceRel: 31 },
  { prompt:'factory',         imgKey:'word32', voiceRel: 32 },
  { prompt:'waterfall',        imgKey:'word33', voiceRel: 33 },
  { prompt:'castle',    imgKey:'word34', voiceRel: 34 },
  { prompt:'city',  imgKey:'word35', voiceRel: 35 },
  { prompt:'village',  imgKey:'word36', voiceRel: 36 },
];


// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ BANK:
// - raw.imgKey (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥): ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô 'word17' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏π‡∏Å‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠
// - ‡∏´‡∏£‡∏∑‡∏≠ raw.key / raw.word ‡∏Å‡πá‡πÑ‡∏î‡πâ (‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ)
// - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏° 'wordN' ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡πâ‡∏ô


(function attachLevel1Images(){
  for (const q of LEVEL1_BANK){
    const img = FIXED_IMG_MAP[q.prompt];
    if (img) q.img = img;
  }
})();

(function attachLevel3Images(){
  for (const q of LEVEL3_BANK){
    const img = FIXED_IMG_MAP[q.prompt];
    if (img) q.img = img;
  }
})();

// ‡∏ú‡∏π‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ NEEDS_BANK (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô FIXED_IMG_MAP)
(function attachNeedsImages(){
  for (const q of NEEDS_BANK){
    const img = FIXED_IMG_MAP[q.prompt];
    if (img) q.img = img;
  }
})();


let __orderL1=[], __idxL1=0; // ‡∏î‡πà‡∏≤‡∏ô 1 : LEVEL1_BANK
let __orderL2=[], __idxL2=0; // ‡∏î‡πà‡∏≤‡∏ô 2 : NEEDS_BANK
let __orderL3=[], __idxL3=0; // ‡∏î‡πà‡∏≤‡∏ô 3 : LEVEL3_BANK

function drawQuestion(){
  if (window.currentLevel === 1){
    if(!__orderL1.length || __idxL1>=__orderL1.length){
      __orderL1 = shuffle([...Array(LEVEL1_BANK.length).keys()]);
      __idxL1 = 0;
    }
const raw = LEVEL1_BANK[__orderL1[__idxL1++]] || {};
const imgKey = raw.imgKey || raw.key || raw.word || null;
// ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå manual ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
const voiceRel = raw.voiceRel;   // 1..50 ‡∏Ç‡∏≠‡∏á "‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô"
const voiceAbs = raw.voiceAbs;   // 1..150 ‡∏Ç‡πâ‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô
return {
  mode:1,
  question: raw.prompt || '',
  img: raw.img,
  choices: raw.choices,
  correctIndex: raw.correct,
  imgKey,
  voiceRel,
  voiceAbs
};


  } else if (window.currentLevel === 2){
    if(!__orderL2.length || __idxL2>=__orderL2.length){
      __orderL2 = shuffle([...Array(NEEDS_BANK.length).keys()]);
      __idxL2 = 0;
    }
    const raw = NEEDS_BANK[__orderL2[__idxL2++]] || {};
    const imgKey = raw.imgKey || raw.key || raw.word || null;
    return { mode:1, question: raw.prompt || '', img: raw.img, choices: raw.choices, correctIndex: raw.correct, imgKey };

  } else if (window.currentLevel === 3){
    if(!__orderL3.length || __idxL3>=__orderL3.length){
      __orderL3 = shuffle([...Array(LEVEL3_BANK.length).keys()]);
      __idxL3 = 0;
    }
    const raw = LEVEL3_BANK[__orderL3[__idxL3++]] || {};
    const imgKey = raw.imgKey || raw.key || raw.word || null;
    return { mode:1, question: raw.prompt || '', img: raw.img, choices: raw.choices, correctIndex: raw.correct, imgKey };
  }
}

function nextRound(){
  if (ended) return;   // ‚ùó ‡∏ñ‡πâ‡∏≤‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà

  // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timeout ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô)
  if (nextRoundTO1){ clearTimeout(nextRoundTO1); nextRoundTO1 = null; }
  if (nextRoundTO2){ clearTimeout(nextRoundTO2); nextRoundTO2 = null; }

  clearRoundObjects(); awaitingAnswer=false; stopTimebar();
  qBox.textContent='';

  nextRoundTO1 = setTimeout(()=>{
    if (ended) return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡∏ï‡πà‡∏≠

    const q = drawQuestion();
    dropQuestion(q.question, q.img);

    // üîä ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏â‡∏•‡∏≤‡∏î
    playQuestionVoiceSmart(window.currentLevel, q);

    nextRoundTO2 = setTimeout(()=>{
      if (ended) return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡∏ï‡πà‡∏≠

      if ([1,2,3].includes(window.currentLevel)){
        spawnTwoImageOptions(q, window.currentLevel);
      } else if (q.mode === 0){
        spawnTwoCircles(q.correctTag);
      } else {
        spawnTwoAnswerCircles(q.choices, q.correctIndex);
      }
      awaitingAnswer = true;
    }, OPT_IN_MS);

  }, Q_DROP_MS + Q_HOLD_MS);
}

function startRoundTimer(){
  // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚Äî ‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ
  awaitingAnswer = true;
}

  function startGame(){
  ensurePreloadForLevel(window.currentLevel);
  if (!IMAGES_READY){
    const st = document.getElementById('startTitle');
    if (st) st.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏û ${__preloadDone}/${__preloadTotal} ...`;
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°
    const waitId = setInterval(()=>{
      if (IMAGES_READY){
        clearInterval(waitId);
        startGame(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°
      }
    }, 120);
    return; 
  }

    document.body.classList.remove('prestart');
    document.body.classList.add('in-game');   
    running=true; ended=false; paused=false;
        window.ended = ended; 
    overlay.style.visibility='hidden'; overlay.style.opacity='0';
    score=0; round=0; updateHUD();
        startGameTimer(); 
    nextRound();
  }

  // ======== ‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà: ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ========
  function endLevel(){
        clearCountdown();
    ended = true;
        window.ended = ended; // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ global
    running = false;
    clearGameTimer();
    stopClockUI();

    // üîí ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    awaitingAnswer = false;
    stopTimebar();
    clearRoundObjects();               
    qBox.textContent = '';             
    cancelPostRoundPhase(); // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å timeout + ‡∏•‡∏ö tap-target ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
    document.querySelectorAll('.tap-target, .fly-emoji, .option').forEach(n=> n.remove());
    qBox.style.display = 'none';     
    if (qImg){
      qImg.style.display = 'none';     
      qImg.removeAttribute('src');
    }
    game.style.visibility = 'hidden';    // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠)

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    finalScoreEl.textContent = String(score);

    // ‚òÖ ‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    const badgeEl = document.getElementById('scoreBadge');
    badgeEl.textContent = getBadgeEmoji(score);

    bgm?.pause?.();
    winSound?.play?.().catch(()=>{});

    overlay.style.visibility = 'visible';
    overlay.style.opacity    = '1';
  }


  function getBadgeEmoji(sc){
    if (sc <= 5)  return '‚ù§Ô∏è';    // 0‚Äì5
    if (sc <= 10) return 'ü•á';    // 6‚Äì10
    if (sc <= 15) return 'üèÜ';    // 11‚Äì15
    return 'üèÜ';
  }


function pauseGame(){
  if(!running||paused) return;
  paused = true;
  clearInterval(roundTimer);
  document.querySelectorAll('.option').forEach(n=> n.style.pointerEvents='none');
  pauseGameTimer();
}

  function resumeGame(){ if(!paused||ended)return; paused=false; 
        document.querySelectorAll('.option').forEach(n=> n.style.pointerEvents='auto'); 
    bgm?.play?.().catch(()=>{}); 

        resumeGameTimer(); 
}
  document.getElementById('pauseBtn')?.addEventListener('click', ()=>{ if(!paused){ pauseGame(); document.getElementById('pauseBtn').textContent='‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠'; } else { resumeGame(); document.getElementById('pauseBtn').textContent='‚è∏ ‡∏´‡∏¢‡∏∏‡∏î'; } });
  

document.getElementById('quickRestart')?.addEventListener('click', ()=>{
  // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á)
  hardCleanupNow({ stopBgm: true });

  // UI ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
  overlay.style.visibility='hidden';
  overlay.style.opacity='0';
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('landing').classList.remove('hide');

  // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠
  try{
    bgm.currentTime = 0;
    bgm.play().catch(()=>{});
  }catch(_){}
});




  restartBtn.addEventListener('click', ()=>{
       cancelPostRoundPhase();
    restorePlayfield();   
    overlay.style.visibility='hidden';
    overlay.style.opacity='0';
    resetState();
    bgm.currentTime = 0;
        ensurePreloadForLevel(window.currentLevel);   // << ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå
    bgm.play().catch(()=>{});
    startGame();
  });


selectLevelBtn.addEventListener('click', ()=>{
  // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠/‡∏õ‡∏∏‡πà‡∏°/‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
  hardCleanupNow({ stopBgm: true });

  ensurePreloadForLevel(window.currentLevel);   // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
  document.getElementById('landing').classList.remove('hide');
  document.getElementById('startScreen').style.display='none';
  overlay.style.visibility='hidden';
  overlay.style.opacity='0';

  // ‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏°‡∏ô‡∏π
  try{
    bgm.currentTime = 0;
    bgm.play().catch(()=>{});
  }catch(_){}
});



  // start screen
  const startScreen  = document.getElementById('startScreen');
  const startBtn     = document.getElementById('startBtn');
  const countdownEl  = document.getElementById('countdown');

let countdownItv = null;
function clearCountdown(){
  if (countdownItv){
    clearInterval(countdownItv);
    countdownItv = null;
  }
  countdownEl.style.display = 'none';
  countdownEl.textContent = '3';
  startBtn.style.display = 'inline-block';
  startBtn.disabled = false;
  startBtn.style.pointerEvents = 'auto';
}


  function openStart(autoCountdown=true){
  clearCountdown();
    document.body.classList.add('prestart');  
    startScreen.style.display='flex';
  
if (autoCountdown) {
  let n = 3;
  countdownEl.textContent = n;
  countdownEl.style.display = 'block';

  countdownItv = setInterval(() => {
    n--;
    if (n > 0) {
      countdownEl.textContent = n;
    } else {
      clearInterval(countdownItv);
      countdownItv = null;
      startScreen.style.display = 'none';
      startGame();
    }
  }, 1000);
}

    else {
      startBtn.disabled=false; startBtn.style.pointerEvents='auto';
      startBtn.style.display='inline-block'; countdownEl.style.display='none';
    }
  }
  startBtn?.addEventListener('click', ()=>{
      clearCountdown(); 
    if(startBtn.disabled) return;
    startBtn.disabled=true; startBtn.style.pointerEvents='none';
    startBtn.style.display='none';
    
let n = 3;
countdownEl.textContent = n;
countdownEl.style.display = 'block';

countdownItv = setInterval(() => {
  n--;
  if (n > 0) {
    countdownEl.textContent = n;
  } else {
    clearInterval(countdownItv);
    countdownItv = null;
    startScreen.style.display = 'none';
    startGame();
    startBtn.disabled = false;
    startBtn.style.pointerEvents = 'auto';
  }
}, 1000);

  });


  document.getElementById('guideBtn')?.addEventListener('click', ()=>{ document.getElementById('landing').classList.add('hide'); document.getElementById('guideScreen').style.display='flex' });
  document.getElementById('guideBack')?.addEventListener('click', ()=>{ document.getElementById('guideScreen').style.display='none'; document.getElementById('landing').classList.remove('hide') });

  // visibility pause
  let wasRunning=false;
  function uiBlockingOpen(){
    const landing=document.getElementById('landing');
    const startOpen = startScreen && startScreen.style.display!=='none';
    const guide=document.getElementById('guideScreen');
    const guideOpen = getComputedStyle(guide).display!=='none';
    const overlayOpen = overlay.style.visibility==='visible';
    return overlayOpen || (!landing.classList.contains('hide')) || startOpen || guideOpen;
  }
  function handleHidden(){ wasRunning = running && !ended && !uiBlockingOpen(); if(wasRunning) pauseGame() }
  function handleVisible(){ if(wasRunning && paused && !ended && !uiBlockingOpen()) resumeGame(); wasRunning=false }
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) handleHidden(); else handleVisible() });
  window.addEventListener('blur', handleHidden); window.addEventListener('focus', handleVisible);

})();
</script>

<!-- ===== ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) ===== -->
<script>
(function(){
  const micBtn   = document.getElementById('micBtn'); // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° = ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  if(!micBtn) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micBtn.textContent='üé§ ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'; micBtn.disabled=true; return }
  const rec = new SR(); rec.lang='th-TH'; rec.continuous=true; rec.interimResults=true;
  function tokensFrom(s){ s=(s||'').toLowerCase().trim(); s=s.replace(/\s*(‡∏Ñ‡πà‡∏∞|‡∏Ñ‡∏£‡∏±‡∏ö|‡∏Ñ‡∏∞|‡∏Æ‡∏∞)$/,''); return s.split(/[\s,Ôºå„ÄÇ\.!?:;„ÄÅ]+/).filter(Boolean) }
  function currentOptionsMap(){ const map=new Map(); 

document.querySelectorAll('.option').forEach(n=>{ 
     const t=(n.textContent||'').trim().toLowerCase(); if(!map.has(t)) map.set(t,[]); map.get(t).push(n) }); return map }
  function pickNearest(arr){ return arr[0] }
  function tryFire(phrase){ const toks=tokensFrom(phrase); if(!toks.length) return false; const cmap=currentOptionsMap(); for(const t of toks){ if(cmap.has(t)){ const node = pickNearest(cmap.get(t)); node?.click(); return true } } return false }
  rec.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i]; const txt=(r[0]?.transcript||'').trim(); if(!txt) continue; tryFire(txt) } };
})();
</script>

<!-- ===== Pose (‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÅ‡∏ï‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå) ===== -->
<script type="module">
import {PoseLandmarker, FilesetResolver} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";
const camBtn = document.getElementById('camBtn');
const video  = document.getElementById('cameraMirror');
const cvs    = document.getElementById('camCanvas');
const ctx    = cvs.getContext('2d', { alpha: true });
const DETECT_W = 320;
let detectCanvas = document.createElement('canvas');
let detectCtx = detectCanvas.getContext('2d', { alpha:false, desynchronized:true });
let CAM_ON=false, landmarker=null, raf=0, stream=null;

function fitCanvas(){ const dpr = CAM_ON? 1 : Math.max(1, window.devicePixelRatio||1); cvs.width=Math.round(innerWidth*dpr); cvs.height=Math.round(innerHeight*dpr); cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr) }
fitCanvas(); addEventListener('resize', fitCanvas);
function coverCropRect(){ const vw=video.videoWidth||640, vh=video.videoHeight||480; const sw=innerWidth, sh=innerHeight; const scale=Math.max(sw/vw, sh/vh); const sW=Math.round(sw/scale), sH=Math.round(sh/scale); const sX=Math.round((vw-sW)/2), sY=Math.round((vh-sH)/2); return {sX,sY,sW,sH,vw,vh,sw,sh} }
function mapToScreen(nx,ny){ const {sX,sY,sW,sH,vw,vh,sw,sh} = coverCropRect(); const px=nx*vw, py=ny*vh; const u=(px-sX)/sW, v=(py-sY)/sH; let x=u*sw, y=v*sh; x=sw-x; return {x,y} }

 	const SHOW_HAND_BALL=false; 
 	const lastHitAt=new WeakMap(); 
 	const HIT_LOCK_MS=160;
function circleIntersectsRect(cx,cy,r, rc){ 
 	const nx=Math.max(rc.left, 
 	Math.min(cx, rc.right)); 
 	const ny=Math.max(rc.top, 
 	Math.min(cy, rc.bottom)); 
 	const dx=cx-nx, dy=cy-ny;    	
 	return (dx*dx+dy*dy)<=r*r 
}

function hitByCircle(center, r){
  if (window.ended) return;   
  const opts = [...document.querySelectorAll('.option, .tap-target')];


  for (const n of opts){
    const rc = n.getBoundingClientRect();
    if (circleIntersectsRect(center.x, center.y, r, rc)){
      const t = performance.now();
      const last = lastHitAt.get(n) || 0;
      if (t - last < HIT_LOCK_MS) continue;
      lastHitAt.set(n, t);
      n.click();
    }
  }
}


async function ensureLandmarker(){ if(landmarker) return landmarker; const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"); landmarker = await PoseLandmarker.createFromOptions(fileset, { baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task" }, runningMode:'VIDEO', numPoses:1, minPoseDetectionConfidence:.35, minPosePresenceConfidence:.35, minTrackingConfidence:.35 }); return landmarker }
function drawHandBall(elbowIdx, wristIdx, lm){ if(!lm[elbowIdx]||!lm[wristIdx]) return null; const elbow = mapToScreen(lm[elbowIdx].x, lm[elbowIdx].y); const wrist = mapToScreen(lm[wristIdx].x, lm[wristIdx].y); const r=24; const L=Math.max(1, Math.hypot(wrist.x-elbow.x, wrist.y-elbow.y)); const ux=(wrist.x-elbow.x)/L, uy=(wrist.y-elbow.y)/L; const HAND_PUSH=1.5, PUSH_PX=6; const center={ x: wrist.x + ux*(r*HAND_PUSH+PUSH_PX), y: wrist.y + uy*(r*HAND_PUSH+PUSH_PX) }; if(SHOW_HAND_BALL){ ctx.beginPath(); ctx.arc(center.x,center.y,r,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke(); } hitByCircle(center, r*.95); return center }
function drawPoseAndColliders(res){ const sw=innerWidth, sh=innerHeight; ctx.clearRect(0,0,sw,sh); if(!res?.landmarks?.length) return; const lm=res.landmarks[0]; drawHandBall(13,15,lm); drawHandBall(14,16,lm) }
function runLoop(){ const step=()=>{ if(!video.videoWidth){ raf=requestAnimationFrame(step); return } const now=performance.now(); try{ const {sX,sY,sW,sH}=coverCropRect(); detectCtx.drawImage(video, sX,sY,sW,sH, 0,0, detectCanvas.width, detectCanvas.height); const res=landmarker.detectForVideo(detectCanvas, now); drawPoseAndColliders(res) }catch(e){} raf=requestAnimationFrame(step) }; raf=requestAnimationFrame(step) }
async function startCamera(){ await ensureLandmarker(); 
    stream = await navigator.mediaDevices.getUserMedia({
  video: { width: 960, height: 540, frameRate: 30, facingMode: 'user' },
  audio: false
});                       
                          
    video.srcObject=stream; await video.play().catch(()=>{}); const vw=video.videoWidth||640, vh=video.videoHeight||480; const ratio=vw/vh; detectCanvas.width=DETECT_W; detectCanvas.height=Math.round(DETECT_W/ratio); video.style.display='block'; cvs.style.display='block'; camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î'; CAM_ON=true; fitCanvas(); runLoop() }
function stopCamera(){ cancelAnimationFrame(raf); if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null } try{ video.pause() }catch(e){} video.removeAttribute('srcObject'); video.style.display='none'; cvs.style.display='none'; ctx.clearRect(0,0,innerWidth,innerHeight); camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏õ‡∏¥‡∏î'; CAM_ON=false; fitCanvas() }
camBtn.addEventListener('click', async ()=>{ if(!stream){ try{ await startCamera() }catch(err){ camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'; camBtn.disabled=true } } else { stopCamera() } });
document.addEventListener('visibilitychange', ()=>{ if(document.hidden && stream) stopCamera() });
</script>

<!-- ===== ‡πÄ‡∏°‡∏ô‡∏π/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ===== -->
<script>
(()=> {
  const landing = document.getElementById('landing');
  const startScreen = document.getElementById('startScreen');
  const guideScreen = document.getElementById('guideScreen');

  document.querySelectorAll('.levelBtn').forEach(btn=>{
  if(btn.id==='guideBtn') return;
  btn.addEventListener('click', ()=>{
    const lv = Number(btn.dataset.level || 0);

    window.currentLevel = lv; 
    if (typeof ensurePreloadForLevel === 'function') {
      ensurePreloadForLevel(lv);
    }
    document.body.classList.add('prestart'); 
    landing.classList.add('hide');
    startScreen.style.display='flex';

        const startBtn    = document.getElementById('startBtn');
        const countdownEl = document.getElementById('countdown');

if (startBtn){
  startBtn.style.display = 'inline-block';
  startBtn.disabled = false;
  startBtn.style.pointerEvents = 'auto';
}
if (countdownEl){
  countdownEl.style.display = 'none';
  countdownEl.textContent = '3';
}

   document.getElementById('countdown').style.display='none';
   const st = document.getElementById('startTitle');

function getMissionTitle(lv){
  switch (lv) {
    case 1: return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå';
    case 2: return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå';
    case 3: return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå';
    default: return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå';
  }
}
    st.textContent = getMissionTitle(lv);
  });
});

  document.getElementById('guideBtn')?.addEventListener('click', ()=>{ landing.classList.add('hide'); guideScreen.style.display='flex' });
  document.getElementById('guideBack')?.addEventListener('click', ()=>{ guideScreen.style.display='none'; landing.classList.remove('hide') });
})();
</script>
</body>
</html>










